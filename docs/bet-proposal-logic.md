# 買い目提案ロジック

`generate_bet_proposal` ツールが買い目を生成するまでの全体フロー。

## 全体フロー

```mermaid
flowchart TD
    START([ユーザー: 買い目提案して]) --> P0

    subgraph P0 [Phase 0: データ収集]
        P0A[レース情報取得] --> P0B[AI予想取得]
        P0B --> P0C[脚質データ取得]
        P0C --> P0D[スピード指数取得]
        P0D --> P0E[近走成績取得]
    end

    P0 --> P1[Phase 1: ペルソナ設定 + 好み設定]
    P1 --> P2

    subgraph P2 [Phase 2: ペース予想 + 軸馬選定]
        P2A[逃げ馬の数からペース予想] --> P2B[全馬の複合スコア算出]
        P2B --> P2C[上位2頭を軸馬に選定]
    end

    P2 --> P3

    subgraph P3 [Phase 3: 難易度判定 + 券種選定]
        P3A[頭数・条件・会場から難易度★算出] --> P3B[★に応じて券種を自動選定]
    end

    P3 --> P4

    subgraph P4 [Phase 4: 買い目生成]
        P4A[相手馬を上位N頭選出] --> P4B[軸×相手の組み合わせ生成]
        P4B --> P4C[オッズ推定 + 期待値計算]
        P4C --> P4D{トリガミ?}
        P4D -->|合成オッズ < 閾値| P4E[除外]
        P4D -->|OK| P4F[期待値順にソート]
        P4F --> P4G[上位N点を採用]
        P4G --> P4H[信頼度の相対割り当て]
    end

    P4 --> P5

    subgraph P5 [Phase 5: 見送りゲート]
        P5A{見送りスコア ≥ 閾値?}
        P5A -->|budgetモード| P5B[予算を50%に削減]
        P5A -->|bankrollモード| P5F[confidence_factorで予算算出]
        P5A -->|No| P5C[予算そのまま]
    end

    P5 --> P6

    subgraph P6 [Phase 6: 予算配分]
        P6A{bankrollモード?}
        P6A -->|Yes| P6B[ダッチング方式で配分]
        P6A -->|No| P6C[信頼度別に配分]
    end

    P6 --> P7[Phase 7: 提案理由 + コメント生成]
    P7 --> RESULT([提案結果を返却])
```

---

## Phase 0: データ収集

5つのデータソースからレース情報を取得する。

| データ | 取得元 | 主な項目 |
|--------|--------|----------|
| レース情報 | JRA-VAN API (EC2 FastAPI) | 出走馬、単勝オッズ、人気順、会場、レース条件 |
| AI予想 | DynamoDB `baken-kaigi-ai-predictions` | 馬番、順位、スコア（0-100pt）、複数ソース |
| 脚質データ | JRA-VAN API `/races/{id}/running-styles` | 逃げ/先行/差し/追込/自在 |
| スピード指数 | DynamoDB `baken-kaigi-speed-indices` | 各馬のスピード指数（複数ソース） |
| 近走成績 | DynamoDB `baken-kaigi-past-performances` | 直近5走の着順 |

データが取得できない場合（DynamoDBテーブルが空など）は、その成分を使わずに後続処理を行う（動的重み正規化で対応）。

AI予想が複数ソースの場合、`_compute_unified_win_probabilities()` で統合単勝率を算出する（Phase 7 参照）。

---

## Phase 1: ペルソナ設定 + 好み設定

### 1-1. ペルソナ設定

`character_type` に応じて各種パラメータを調整する。デフォルト値をベースに、ペルソナ固有の設定で上書きする。

```mermaid
flowchart LR
    CT{character_type} -->|analyst| A[バランス型<br>デフォルト設定]
    CT -->|conservative| B[堅実型<br>AI重視・点数絞り]
    CT -->|intuition| C[直感型<br>オッズ乖離重視]
    CT -->|aggressive| D[攻撃型<br>穴狙い・三連単]
```

#### パラメータ一覧

| パラメータ | analyst | conservative | intuition | aggressive |
|-----------|---------|-------------|-----------|------------|
| AI指数の重み `weight_ai_score` | 0.5 | **0.6** | 0.3 | 0.3 |
| オッズ乖離の重み `weight_odds_gap` | 0.3 | 0.2 | **0.5** | **0.5** |
| ペース相性の重み `weight_pace_compat` | 0.2 | 0.2 | 0.2 | 0.2 |
| スピード指数の重み `weight_speed_index` | 0.2 | 0.2 | 0.2 | 0.2 |
| 近走フォームの重み `weight_form` | 0.15 | 0.15 | 0.15 | 0.15 |
| 高信頼への配分 `allocation_high` | 50% | **60%** | 40% | 35% |
| 中信頼への配分 `allocation_medium` | 30% | 30% | 30% | **25%** |
| 低信頼への配分 `allocation_low` | 20% | **10%** | 30% | **40%** |
| トリガミ閾値 | 2.0 | **2.5** | 1.5 | 1.5 |
| 見送り閾値 | 7 | **6** | 8 | **9** |
| 最大点数 | 8 | **5** | 8 | 8 |
| 基本投入率 `base_rate` | 3% | **2%** | 3% | **5%** |

#### 券種マッピング（難易度★別）

| 難易度 | analyst | conservative | intuition | aggressive |
|--------|---------|-------------|-----------|------------|
| ★1-2 | 馬連・馬単 | 馬連・ワイド | 馬単・馬連 | 馬単・三連単 |
| ★3 | 馬連・三連複 | ワイド・馬連 | 馬単・三連複 | 三連単・三連複 |
| ★4 | 三連複・ワイド | ワイド | 三連複・三連単 | 三連単・三連複 |
| ★5 | ワイド | ワイド | 三連複・ワイド | 三連複・三連単 |

### 1-2. 好み設定（BettingPreference）

ペルソナ設定の上に、ユーザーの好み設定を上書きする。3つの軸がある。

```mermaid
flowchart TD
    PREF[好み設定] --> TS[target_style<br>狙い方]
    PREF --> BTP[bet_type_preference<br>券種]
    PREF --> PRI[priority<br>重視ポイント]

    TS -->|honmei| TS1[本命狙い: 堅い券種にシフト]
    TS -->|big_longshot| TS2[大穴狙い: 高配当券種にシフト]

    BTP -->|trio_focused| BTP1[三連複中心]
    BTP -->|exacta_focused| BTP2[馬単中心]
    BTP -->|quinella_focused| BTP3[馬連中心]
    BTP -->|wide_focused| BTP4[ワイド中心]
    BTP -->|auto| BTP5[ペルソナの券種マッピングを使用]

    PRI -->|hit_rate| PRI1[的中率重視: 相手馬5頭]
    PRI -->|roi| PRI2[ROI重視: 相手馬3頭]
    PRI -->|balanced| PRI3[バランス: 相手馬4頭]
```

#### 適用優先度

1. `bet_type_preference` が `auto` 以外 → 券種マッピングを完全に上書き
2. `bet_type_preference` が `auto` かつ `target_style` あり → 狙い方に応じた券種マッピングにシフト
3. どちらもなし → ペルソナのデフォルト券種マッピングを使用

#### target_style 別の券種マッピング

| 難易度 | honmei（本命狙い） | big_longshot（大穴狙い） |
|--------|-------------------|----------------------|
| ★1-2 | 馬連・ワイド | 馬単・三連複 |
| ★3 | 馬連・馬単 | 三連複・三連単 |
| ★4 | 馬連・ワイド | 三連複・三連単 |
| ★5 | ワイド | 三連複・ワイド |

#### priority → 相手馬数

| priority | 相手馬数 `max_partners` |
|----------|----------------------|
| hit_rate | 5 |
| balanced | 4（デフォルト） |
| roi | 3 |

---

## Phase 2: ペース予想 + 軸馬選定

### ペース予想

脚質データから逃げ馬の数をカウントし、ペースを判定する。

```
逃げ馬 3頭以上 → ハイペース（差し・追込有利）
逃げ馬 2頭    → ミドルペース（先行・差し有利）
逃げ馬 0〜1頭 → スローペース（逃げ・先行有利）
```

脚質データが取得できない場合、ペースは空文字（不明）となり、ペース相性スコアにはペナルティ（40pt）が適用される。

### 複合スコアの算出

各馬に5つのスコア成分を計算し、重み付き合算で複合スコア（0〜100pt）を算出する。

```mermaid
flowchart TD
    subgraph 5つのスコア成分
        AI[AI指数スコア<br>weight: 0.5]
        OG[オッズ乖離スコア<br>weight: 0.3]
        PC[ペース相性スコア<br>weight: 0.2]
        SI[スピード指数スコア<br>weight: 0.2<br>※データなし時は除外]
        FM[近走フォームスコア<br>weight: 0.15<br>※データなし時は除外]
    end

    AI --> NORM[動的重み正規化]
    OG --> NORM
    PC --> NORM
    SI -.->|データあり| NORM
    FM -.->|データあり| NORM

    NORM --> SCORE[複合スコア = Σ(スコア × 正規化重み)]
    SCORE --> RANK[全馬をスコア降順ソート]
    RANK --> TOP[上位2頭 = 軸馬]
```

#### 動的重み正規化

スピード指数・近走フォームはデータがない場合がある。データがある成分だけを使い、重みの合計が1.0になるよう正規化する。

```
例1: 5成分全てデータあり
  合計重み = 0.5 + 0.3 + 0.2 + 0.2 + 0.15 = 1.35
  AI正規化重み = 0.5 / 1.35 = 0.370
  オッズ乖離正規化重み = 0.3 / 1.35 = 0.222
  ...

例2: スピード指数・近走フォームなし（基本3成分のみ）
  合計重み = 0.5 + 0.3 + 0.2 = 1.0
  AI正規化重み = 0.5 / 1.0 = 0.500
  オッズ乖離正規化重み = 0.3 / 1.0 = 0.300
  ペース相性正規化重み = 0.2 / 1.0 = 0.200
```

#### 統合単勝率（unified_probs）使用時

AI予想が複数ソースの場合、統合単勝率から順位を再計算してAI指数スコアを算出する。

```python
# 統合確率から順位マップを生成
sorted_probs = sorted(unified_probs.items(), key=lambda x: x[1], reverse=True)
rank_map = {hn: i + 1 for i, (hn, _) in enumerate(sorted_probs)}
ai_rank = rank_map.get(horse_number, 99)
ai_score = max(0.0, 100.0 - (ai_rank - 1) * 5.0)
```

---

### 成分1: AI指数スコア（0〜100pt）

AI予想データの順位からスコアに変換する。

```
AI指数スコア = max(0, 100 - (順位 - 1) × 5)
```

| AI順位 | スコア |
|--------|--------|
| 1位 | 100pt |
| 2位 | 95pt |
| 3位 | 90pt |
| 5位 | 80pt |
| 10位 | 55pt |
| 15位 | 30pt |
| 18位 | 15pt |
| 21位以上 | 0pt |

AI予想にヒットしない馬（`horse_number` が一致しない）は ai_rank=99 となり、スコア=0pt。

---

### 成分2: オッズ乖離スコア（20〜100pt）

AI順位と人気順位の乖離から「市場が見落としている馬」を検出する。

```mermaid
flowchart TD
    INPUT[AI順位 × 人気順位] --> C1{AI 5位以内 かつ<br>人気 6番以下?}
    C1 -->|Yes| BONUS[80 + (人気 - AI順位) × 2<br>上限100pt<br>市場の見落とし]
    C1 -->|No| C2{AI 3位以内 かつ<br>人気 3番以内?}
    C2 -->|Yes| NORM[60pt<br>順当評価]
    C2 -->|No| C3{AI 6位以下 かつ<br>人気 3番以内?}
    C3 -->|Yes| LOW[20pt<br>過剰人気]
    C3 -->|No| DEFAULT[50pt<br>標準]
```

**具体例**:

| ケース | AI順位 | 人気 | スコア | 意味 |
|--------|--------|------|--------|------|
| AI1位・10番人気 | 1 | 10 | 98pt | 市場が見落としている（妙味大） |
| AI2位・8番人気 | 2 | 8 | 92pt | 市場が見落としている |
| AI1位・1番人気 | 1 | 1 | 60pt | 順当（AI・市場一致） |
| AI8位・2番人気 | 8 | 2 | 20pt | 過剰人気（AIは低評価） |
| AI4位・6番人気 | 4 | 6 | 84pt | 市場の見落とし候補 |
| AI6位・6番人気 | 6 | 6 | 50pt | 標準 |

**人気データなし**の場合: デフォルト50pt（不確実性を反映）

---

### 成分3: ペース相性スコア（25〜75pt）

予想ペースと馬の脚質の相性をマトリクスで評価する。

```
ペース相性スコア = 50 + 相性値 × 25
```

相性値マトリクス（-1.0 〜 +1.0）:

| ペース＼脚質 | 逃げ | 先行 | 差し | 追込 | 自在 |
|---|---|---|---|---|---|
| **ハイ** | -1.0 → 25pt | -0.5 → 37.5pt | **+1.0 → 75pt** | **+1.0 → 75pt** | +0.5 → 62.5pt |
| **ミドル** | 0 → 50pt | +0.5 → 62.5pt | +0.5 → 62.5pt | 0 → 50pt | +0.5 → 62.5pt |
| **スロー** | **+1.0 → 75pt** | **+1.0 → 75pt** | -0.5 → 37.5pt | -1.0 → 25pt | +0.5 → 62.5pt |

- 脚質が「不明」or マトリクスにない場合: 相性値=0.0 → 50pt
- ペースデータなし **かつ** 脚質データなし: ペナルティ → 40pt

---

### 成分4: スピード指数スコア（15〜100pt）

DynamoDBから取得したスピード指数データを馬ごとに処理する。

```mermaid
flowchart TD
    SI1[複数ソースの指数を<br>馬ごとに収集] --> SI2[各馬の平均指数を計算]
    SI2 --> SI3[平均指数で降順ソート<br>→ レース内順位付け]
    SI3 --> SI4[順位をスコアに変換]
```

**スコア変換**:

```
スコア = 100 - (順位 - 1) × 85 / (出走頭数 - 1)
```

| 順位（18頭中） | スコア |
|---------------|--------|
| 1位 | 100.0pt |
| 2位 | 95.0pt |
| 5位 | 80.0pt |
| 10位 | 55.0pt |
| 18位 | 15.0pt |

出走頭数が1頭の場合は100pt。データなしの場合は `None` を返し、複合スコア計算から除外される。

---

### 成分5: 近走フォームスコア（15〜100pt）

直近5走の着順を重み付き加重平均で評価する。最近の成績ほど重みが大きい。

**着順→スコア変換**:

| 着順 | スコア |
|------|--------|
| 1着 | 100pt |
| 2着 | 85pt |
| 3着 | 70pt |
| 4着 | 55pt |
| 5着 | 45pt |
| 6〜9着 | 30pt |
| 10着以降 | 15pt |

**重み（レーセンシー重み）**:

| 走順 | 重み |
|------|------|
| 直近1走前 | 5 |
| 2走前 | 4 |
| 3走前 | 3 |
| 4走前 | 2 |
| 5走前 | 1 |

**計算式**:

```
フォームスコア = Σ(着順スコア × 重み) / Σ(重み)
```

**例**: 直近5走が [1着, 3着, 2着, 5着, 8着] の場合:

```
= (100×5 + 70×4 + 85×3 + 45×2 + 30×1) / (5+4+3+2+1)
= (500 + 280 + 255 + 90 + 30) / 15
= 1155 / 15
= 77.0pt
```

---

### 軸馬の選定

1. ユーザーが `axis_horses` を指定 → その馬番を使用（出走馬に存在するもののみ）
2. 未指定 → 全馬の複合スコアを計算し、上位2頭を選定

```python
# 複合スコア降順でソート → 上位 MAX_AXIS_HORSES(=2) 頭
scored.sort(key=lambda x: x["composite_score"], reverse=True)
return scored[:2]
```

---

## Phase 3: 難易度判定 + 券種選定

### 難易度スコア算出

3カテゴリの要因から `upset_score` を計算し、★に変換する。

```
upset_score = 0

# 1. 頭数
16頭以上: +1  /  13〜15頭: +1  /  8頭以下: -1

# 2. レース条件
ハンデ戦: +2  /  障害戦: +2  /  新馬戦: +1  /  G1: -1  /  G2: -1

# 3. 会場
福島/中京/小倉: +1  /  京都/阪神: -1

# ★変換
difficulty_stars = clamp(upset_score + 2, 1, 5)
```

> **注意**: ★はベースラインの参考値。LLMはこの★に加え、AI予想のスコア分散（上位が僅差なら混戦、1頭抜けなら堅い）・ペース予想（ハイペースは前崩れで荒れやすい）・馬場（芝の方がダートより荒れやすい傾向）・距離（短距離はスピード勝負で波乱が起きやすい）を総合的に考慮してコメントする。

**★早見表の例**:

| 条件 | upset_score | ★ |
|------|------------|---|
| 東京G1・16頭 | +1(頭数) -1(G1) = 0 | ★2 |
| 福島ハンデ・16頭 | +1(頭数) +2(ハンデ) +1(福島) = +4 | ★5 |
| 阪神G2・12頭 | 0(頭数) -1(G2) -1(阪神) = -2 | ★1 |
| 中京未勝利・18頭 | +1(頭数) +1(中京) = +2 | ★4 |

### 券種の自動選定

ペルソナ（+ 好み設定で上書き後）の `difficulty_bet_types` マッピングを参照して、難易度★から券種を自動選定する。ユーザーが `preferred_bet_types` を指定した場合はそちらを優先。

```mermaid
flowchart LR
    S1[★1-2 堅い] --> BT1[馬連・馬単]
    S3[★3 標準] --> BT3[馬連・三連複]
    S4[★4 荒れ模様] --> BT4[三連複・ワイド]
    S5[★5 大荒れ] --> BT5[ワイド]
```

---

## Phase 4: 買い目生成

### 相手馬の選出

軸馬以外の全馬を複合スコア順にソートし、上位 `max_partners` 頭を相手馬に選出。

`max_partners` は好み設定の `priority` によって変動する（デフォルト4頭）。

| priority | 相手馬数 |
|----------|---------|
| hit_rate | 5頭 |
| balanced | 4頭（デフォルト） |
| roi | 3頭 |

### 組み合わせ生成

券種に応じて軸馬×相手馬の組み合わせを生成する。

```
単勝/複勝の場合:
  軸馬のみ = 最大 2通り

馬連/馬単/ワイドの場合:
  各軸 × 各相手 = 最大 2軸 × N相手

  馬連: 馬番昇順で表示 (例: 3-7)
  馬単: 軸→相手の順 (例: 3→7)
  ワイド: 馬番昇順で表示 (例: 3-7)

三連複/三連単の場合:
  各軸 × C(N相手, 2)

  三連複: 馬番昇順 (例: 1-3-7)
  三連単: 軸→相手1→相手2 (例: 1→3→7)
```

### オッズ推定

単勝オッズから各券種の推定オッズを算出する。

```mermaid
flowchart LR
    ODDS[各馬の単勝オッズ] --> GEO[幾何平均を計算]
    GEO --> MUL[× 券種別補正係数]
    MUL --> EST[推定オッズ]
```

**幾何平均**:

```
2頭の場合: 幾何平均 = √(オッズA × オッズB)
3頭の場合: 幾何平均 = ∛(オッズA × オッズB × オッズC)
```

**券種別補正係数**:

| 券種 | 補正係数 | 根拠 |
|------|---------|------|
| ワイド `quinella_place` | 0.45 | 3着内なので的中率高く、オッズ低め |
| 馬連 `quinella` | 0.85 | 着順不問の2頭組み合わせ |
| 三連複 `trio` | 1.5 | 3頭組み合わせ・着順不問 |
| 馬単 `exacta` | 1.7 | 着順指定で馬連より高配当 |
| 三連単 `trifecta` | 4.0 | 着順指定3頭で高配当 |

**具体例**: 単勝10倍と単勝20倍の馬連

```
幾何平均 = √(10 × 20) = √200 ≈ 14.1
推定オッズ = 14.1 × 0.85 ≈ 12.0倍
```

### 期待値計算

#### 従来方式（単一AIソース）

推定オッズと統計的な的中確率から期待値を計算する。

```
期待値 = 推定オッズ × 推定的中率
```

**推定的中率の算出**:

1. 各馬の人気順位から JRA統計テーブルのベース確率を取得
2. 出走頭数による補正係数を適用（少頭数ほど上位人気が有利）
3. レース条件による補正係数を適用（ハンデ戦は荒れやすいなど）

**JRA統計テーブル（18頭基準）**:

| 人気 | 単勝率 | 複勝率 | 2着内率 |
|------|--------|--------|---------|
| 1番人気 | 33.0% | 65.0% | 52.0% |
| 2番人気 | 19.0% | 52.0% | 38.0% |
| 3番人気 | 13.0% | 43.0% | 30.0% |
| 5番人気 | 7.0% | 30.0% | 19.0% |
| 10番人気 | 2.0% | 10.0% | 6.0% |
| 18番人気 | 0.2% | 1.5% | 1.0% |

**出走頭数補正**: 8頭立ての1番人気は18頭立てより勝ちやすい。

| 頭数 | 1番人気 | 2番人気 | 3番人気 |
|------|---------|---------|---------|
| 8頭 | ×1.25 | ×1.20 | ×1.15 |
| 10頭 | ×1.15 | ×1.12 | ×1.10 |
| 14頭 | ×1.05 | ×1.04 | ×1.03 |
| 18頭 | ×1.00 | ×1.00 | ×1.00 |

中間頭数は線形補間。

**レース条件補正**:

| 条件 | 補正係数 | 傾向 |
|------|---------|------|
| G1 | 1.05 | 堅い |
| ハンデ戦 | 0.85 | 荒れやすい |
| 障害戦 | 0.80 | 荒れやすい |
| 新馬戦 | 0.88 | データ不足で荒れやすい |
| 通常 | 1.00 | - |

#### Harvilleモデル方式（複数AIソース / unified_probs 使用時）

統合単勝率が利用可能な場合、Harvilleモデルで券種別の組合せ確率を直接算出する。

```
Harville 2着確率: P(A=1着, B=2着) = P(A) × P(B) / (1 - P(A))
Harville 3着確率: P(A=1着, B=2着, C=3着) = P(A) × P(B) / (1 - P(A)) × P(C) / (1 - P(A) - P(B))
```

**券種別の確率算出**:

| 券種 | 計算方法 |
|------|---------|
| 単勝 | P(A) |
| 複勝 | P(A) × 3（3着内近似） |
| 馬連 | Harville(A,B) + Harville(B,A) |
| 馬単 | Harville(A,B) |
| ワイド | 全非選択馬Cに対する6順列のtrifecta合算 |
| 三連複 | 6順列のtrifecta合算 |
| 三連単 | Harville(A,B,C) |

```
期待値 = 推定オッズ × 組合せ確率
```

#### 期待値の評価

| 期待値 | 評価 |
|--------|------|
| ≥ 1.2 | 妙味あり |
| 0.9 〜 1.2 | 適正 |
| 0.7 〜 0.9 | やや割高 |
| < 0.7 | 割高 |

### トリガミチェック

推定オッズがトリガミ閾値未満の買い目を除外する。

```
推定オッズ < トリガミ閾値 → 除外

閾値はペルソナで異なる:
  analyst:      2.0倍
  conservative: 2.5倍（堅実なので厳しく）
  intuition:    1.5倍
  aggressive:   1.5倍
```

### 信頼度の相対割り当て

トリガミ除外後の買い目を期待値降順でソートし、上位N点を採用。その中で複合スコアに基づいて信頼度を相対的に割り当てる。

```mermaid
flowchart TD
    INPUT[N点の買い目リスト] --> CHECK{スコアにばらつきあり?}
    CHECK -->|Yes| RANK[スコア降順でランク付け]
    CHECK -->|全て同値| EV{期待値にばらつきあり?}
    EV -->|Yes| RANK_EV[期待値降順でランク付け]
    EV -->|全て同値| ALL_MED[全て medium]

    RANK --> SPLIT
    RANK_EV --> SPLIT

    SPLIT[上位1/3 → high<br>中位 → medium<br>下位1/3 → low]
```

特殊ケース:
- 1件 → `high`
- 2件 → 上位 `high`、下位 `medium`

---

## Phase 5: 見送りゲート

複数の要因から見送りスコア（0〜10）を算出する。

```mermaid
flowchart TD
    D[難易度<br>★5: +4 / ★4: +3 / ★3: +1 / ★1-2: -1] --> SS((見送り<br>スコア))
    AI[AI上位5頭のスコア差<br>≤30pt: +3 / ≤60pt: +1] --> SS
    OD[オッズ団子状態: +1] --> SS
    MH[16頭以上: +1] --> SS
    HP[ハイペース予想: +1] --> SS

    SS --> CLAMP[0〜10にクランプ]
    CLAMP --> MODE{モード判定}
    MODE -->|budgetモード| J{スコア ≥ 閾値?}
    MODE -->|bankrollモード| CF[confidence_factor算出]

    J -->|≥ 閾値| SKIP[見送り推奨<br>予算50%削減]
    J -->|≥ 5| CAUTION[慎重に検討]
    J -->|< 5| OK[通常判断]

    CF --> BUDGET[レース予算 = bankroll × base_rate × confidence_factor]
```

見送り閾値はペルソナで異なる:
- conservative: 6（慎重派なので早めに見送り）
- analyst: 7
- intuition: 8
- aggressive: 9（攻撃型は見送りにくい）

### confidence_factor（bankrollモード）

見送りスコアを0.0〜2.0の連続値にマッピングする。budgetモードの「閾値超えたら50%削減」という段階的な処理を、連続的なスケーリングに置き換える。

```
confidence_factor = max(0.0, 2.0 - skip_score × (1.75 / 8))

skip_score ≥ 9 → 0.0（見送り）
```

| 見送りスコア | confidence_factor | 意味 |
|-------------|-------------------|------|
| 0 | 2.00 | 非常に自信あり |
| 3 | 1.34 | やや自信あり |
| 5 | 0.91 | 標準 |
| 7 | 0.47 | 慎重 |
| 9+ | 0.00 | 見送り |

**レース予算の算出**:

```
raw_budget = bankroll × base_rate × confidence_factor
race_budget = min(raw_budget, bankroll × MAX_RACE_BUDGET_RATIO)

例: bankroll=100,000円、base_rate=3%、skip_score=3
  → confidence_factor = 1.34
  → raw_budget = 100,000 × 0.03 × 1.34 = 4,020円 → 4,000円（100円単位）
  → 上限 = 100,000 × 0.10 = 10,000円
  → race_budget = 4,000円
```

**具体例**: 福島ハンデ・16頭・AI上位混戦・ハイペース予想

```
難易度★5 → +4
AI上位5頭差20pt → +3
オッズ団子 → +1
16頭 → +1
ハイペース → +1
合計 = 10 → 見送り推奨
  budgetモード: 予算50%削減
  bankrollモード: confidence_factor=0.0 → 見送り（0円）
```

---

## Phase 6: 予算配分

### budgetモード: 信頼度別配分

```mermaid
flowchart TD
    B[予算] --> SPLIT[信頼度別に分割<br>high:50% / medium:30% / low:20%]
    SPLIT --> H[highグループ]
    SPLIT --> M[mediumグループ]
    SPLIT --> L[lowグループ]

    H --> EV_H[期待値に比例配分<br>100円単位に丸め<br>最低100円保証]
    M --> EV_M[期待値に比例配分]
    L --> EV_L[期待値に比例配分]

    EV_H --> CHECK{予算超過?}
    EV_M --> CHECK
    EV_L --> CHECK

    CHECK -->|Yes| REDUCE[低信頼度から削減]
    CHECK -->|No| REMAIN{余剰あり?}
    REMAIN -->|Yes| ADD[EV比率で追加配分<br>丸め残りはEV最大に加算]
    REMAIN -->|No| DONE[完了]
```

#### 配分の詳細ルール

1. **グループ予算**: 存在するグループのみに配分し、比率を正規化
   - high のみ存在 → 100% が high に
   - high + low → high 71.4%, low 28.6%

2. **グループ内配分**: 期待値に比例して配分
   ```
   各買い目の金額 = グループ予算 × (その買い目のEV / グループ内EV合計)
   → 100円単位に丸め（切り捨て）
   → 最低100円を保証
   ```

3. **予算超過時**: 低信頼度の買い目から順に削減（最低100円は維持）

4. **余剰予算**: EV比率に応じて追加配分。丸め残りはEV最大の買い目に加算

5. **予算不足時**: 予算で買える最大点数 `= budget // 100` を超える場合、高信頼度順に絞り込み

### bankrollモード: ダッチング方式

どの買い目が的中しても同額の払い戻しになるように、オッズの逆数に比例して配分する。

```mermaid
flowchart TD
    B[レース予算] --> FILTER[期待値 > 1.0 の買い目を選出]
    FILTER --> CALC[オッズの逆数合計から<br>合成オッズを計算]
    CALC --> ALLOC[各買い目に<br>合成オッズ / 個別オッズ<br>の比率で配分]
    ALLOC --> CHECK{予算超過?}
    CHECK -->|Yes| REMOVE[最小配分の買い目を除外<br>→ 再帰的に再配分]
    CHECK -->|No| REMAIN{余剰あり?}
    REMAIN -->|Yes| ADD[先頭の買い目に加算]
    REMAIN -->|No| DONE[完了]
```

**計算式**:

```
合成オッズ = 1 / Σ(1/オッズ_i)
各買い目の金額 = レース予算 × 合成オッズ / オッズ_i
```

**例**: 3つの買い目（オッズ 5.0, 8.0, 12.0）、レース予算 3,000円

```
逆数合計 = 1/5 + 1/8 + 1/12 = 0.200 + 0.125 + 0.083 = 0.408
合成オッズ = 1 / 0.408 ≈ 2.45

配分:
  オッズ5.0 → 3,000 × 2.45 / 5.0 = 1,470 → 1,400円
  オッズ8.0 → 3,000 × 2.45 / 8.0 = 918 → 900円
  オッズ12.0 → 3,000 × 2.45 / 12.0 = 612 → 600円
  合計 = 2,900円（残り100円は先頭に加算）
```

---

## Phase 7: 提案理由 + コメント生成

### AI合議レベル判定

#### 統合単勝率（unified_probs）使用時

上位2頭の確率差で判定する。

| 上位2頭の確率差 | 合議レベル |
|----------------|-----------|
| ≥ 0.15 | 明確な上位 |
| 0.08〜0.14 | 概ね合意 |
| 0.04〜0.07 | やや接戦 |
| < 0.04 | 混戦 |

#### 単一AIソース使用時

AI予想の上位2頭のスコア差で判定する。

| 上位2頭のスコア差 | 合議レベル |
|------------------|-----------|
| ≥ 50pt | 明確な上位 |
| 20〜49pt | 概ね合意 |
| 10〜19pt | やや接戦 |
| < 10pt | 混戦 |

### 提案理由（proposal_reasoning）

LLMナレーション（Claude Haiku）を使用して、レース固有の特徴を踏まえた提案理由を動的に生成する。

```mermaid
flowchart TD
    DATA[分析データを構造化] --> LLM[Claude Haiku<br>Bedrock Converse API]
    LLM --> CHECK{4セクション揃っている?}
    CHECK -->|Yes| RESULT[LLMナレーションを使用]
    CHECK -->|No| FALLBACK[テンプレート生成にフォールバック]
    LLM -->|エラー| FALLBACK
```

**4セクション構成**:

```
【軸馬選定】
  各軸馬のAI順位・スコア・総合評価・単勝オッズ・ペース相性を記載
  スピード指数・近走フォームがある場合はその推移にも言及

【券種】
  難易度★に基づく選定理由 + AI指数差による補足

【組み合わせ】
  相手馬のAI順位・最大期待値を記載

【リスク】
  AI合議レベル・見送りスコア・トリガミリスクの有無
```

**LLMナレーションの特徴**:
- モデル: Claude Haiku 4.5（`jp.anthropic.claude-haiku-4-5-20251001-v1:0`）
- 温度: 0.7（レースごとに異なる表現を生成）
- AI合議レベルに応じてトーン制御（明確な上位→確信的、混戦→慎重）
- 4セクション不足時やエラー時はテンプレート生成にフォールバック

---

## 統合単勝率の算出

AI予想が複数ソースの場合、全ソースのスコアを統合して馬ごとの単勝率を算出する。

```mermaid
flowchart TD
    S1[ソース1の予想] --> N1[ソース内正規化<br>score / Σscores]
    S2[ソース2の予想] --> N2[ソース内正規化]
    S3[ソースNの予想] --> N3[ソース内正規化]

    N1 --> AVG[馬ごとにソース間平均]
    N2 --> AVG
    N3 --> AVG

    AVG --> RENORM[再正規化<br>合計=1.0を保証]
    RENORM --> RESULT[統合単勝率<br>horse_number → probability]
```

**計算手順**:

1. 各ソース内でスコアを正規化（`score_i / Σscores` → 確率）
2. 馬ごとに利用可能なソース間で平均を取る
3. 再正規化して合計1.0にする

統合単勝率が算出された場合、Phase 2の複合スコア計算とPhase 4の期待値計算でHarvilleモデルが使用される。

---

## 定数一覧

| 定数 | 値 | 用途 |
|------|-----|------|
| `MAX_AXIS_HORSES` | 2 | 軸馬の最大数 |
| `MAX_PARTNERS` | 4 | 相手馬の最大数（デフォルト） |
| `MAX_BETS` | 8 | 買い目の最大数（budgetモード、analyst デフォルト） |
| `MIN_BET_AMOUNT` | 100 | 最低掛け金（円） |
| `TORIGAMI_COMPOSITE_ODDS_THRESHOLD` | 2.0 | トリガミ閾値（analyst デフォルト） |
| `SKIP_GATE_THRESHOLD` | 7 | 見送り推奨の閾値（analyst デフォルト） |
| `SKIP_BUDGET_REDUCTION` | 0.5 | 見送り時の予算削減率（budgetモード） |
| `MAX_RACE_BUDGET_RATIO` | 0.10 | 1レースあたりの予算上限（bankroll比） |
| `DEFAULT_BASE_RATE` | 0.03 | デフォルト基本投入率（bankrollモード） |
| `ODDS_GAP_BONUS_THRESHOLD` | 5 | オッズ乖離ボーナスのAI順位/人気閾値 |
| `WEIGHT_AI_SCORE` | 0.5 | AI指数の重み（analyst デフォルト） |
| `WEIGHT_ODDS_GAP` | 0.3 | オッズ乖離の重み |
| `WEIGHT_PACE_COMPAT` | 0.2 | ペース相性の重み |
| `WEIGHT_SPEED_INDEX` | 0.2 | スピード指数の重み |
| `WEIGHT_FORM` | 0.15 | 近走フォームの重み |
| `AI_SCORE_CLOSE_GAP` | 30 | 見送り: 混戦判定のスコア差 |
| `AI_SCORE_MODERATE_GAP` | 60 | 見送り: やや接戦判定のスコア差 |
| `NARRATOR_MODEL_ID` | `jp.anthropic.claude-haiku-4-5-20251001-v1:0` | LLMナレーションのモデル |

---

## 関連ファイル

| ファイル | 役割 |
|---------|------|
| `backend/agentcore/tools/bet_proposal.py` | 買い目提案の主ロジック（複合スコア・軸馬選定・組み合わせ生成・予算配分・LLMナレーション・統合単勝率・Harvilleモデル） |
| `backend/agentcore/tools/bet_analysis.py` | 期待値計算・JRA統計確率テーブル・Harvilleモデル基本関数 |
| `backend/agentcore/tools/pace_analysis.py` | ペース予想・難易度判定 |
| `backend/agentcore/tools/risk_analysis.py` | 見送り判定 |
| `backend/agentcore/tools/race_data.py` | レースデータ取得 |
| `backend/agentcore/tools/ai_prediction.py` | AI予想取得（DynamoDB） |
| `backend/agentcore/tools/speed_index.py` | スピード指数取得（DynamoDB） |
| `backend/agentcore/tools/past_performance.py` | 近走成績取得（DynamoDB） |
| `backend/agentcore/tools/constants.py` | 共通定数（閾値・係数） |
| `backend/agentcore/prompts/bet_proposal.py` | エージェント用システムプロンプト |
| `backend/agentcore/prompts/consultation.py` | 相談モード用プロンプト（難易度コメント指示含む） |
