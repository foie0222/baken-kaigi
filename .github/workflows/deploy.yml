name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:  # 手動トリガー

permissions:
  id-token: write
  contents: read

jobs:
  # CDKデプロイジョブ
  deploy-cdk:
    name: Deploy CDK Stacks
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: |
      github.ref == 'refs/heads/main' &&
      github.repository == 'foie0222/baken-kaigi' &&
      (github.event_name == 'push' || github.event_name == 'workflow_dispatch')

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ap-northeast-1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: cdk/requirements.txt

      - name: Install CDK
        run: npm install -g aws-cdk@2

      - name: Install Python dependencies
        run: pip install -r requirements.txt
        working-directory: cdk

      - name: CDK Deploy
        run: cdk deploy --all --context jravan=true --require-approval never
        working-directory: cdk

      - name: Output CDK deployment summary
        run: |
          echo "## CDK Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Deployment completed at $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- AWS Region: ap-northeast-1" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployed Stacks" >> $GITHUB_STEP_SUMMARY
          cdk ls --context jravan=true >> $GITHUB_STEP_SUMMARY
        working-directory: cdk

  # AgentCore Runtimeデプロイジョブ
  deploy-agentcore:
    name: Deploy AgentCore Runtime
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: deploy-cdk  # CDKデプロイ後に実行
    if: |
      github.ref == 'refs/heads/main' &&
      github.repository == 'foie0222/baken-kaigi' &&
      (github.event_name == 'push' || github.event_name == 'workflow_dispatch')

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ap-northeast-1

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install AgentCore CLI
        run: pip install bedrock-agentcore-starter-toolkit

      - name: Generate AgentCore config for CI
        working-directory: backend/agentcore
        run: |
          # CI環境用の設定ファイルを生成（相対パス使用）
          cat > .bedrock_agentcore.yaml << 'EOF'
          default_agent: baken_kaigi_cli
          agents:
            baken_kaigi_cli:
              name: baken_kaigi_cli
              language: python
              node_version: '20'
              entrypoint: agent.py
              deployment_type: direct_code_deploy
              runtime_type: PYTHON_3_12
              platform: linux/arm64
              container_runtime: null
              source_path: .
              aws:
                execution_role: arn:aws:iam::688567287706:role/AmazonBedrockAgentCoreSDKRuntime-ap-northeast-1-c31c3fd2fb
                execution_role_auto_create: false
                account: '688567287706'
                region: ap-northeast-1
                ecr_repository: null
                ecr_auto_create: false
                s3_path: s3://bedrock-agentcore-codebuild-sources-688567287706-ap-northeast-1
                s3_auto_create: false
                network_configuration:
                  network_mode: PUBLIC
                  network_mode_config: null
                protocol_configuration:
                  server_protocol: HTTP
                observability:
                  enabled: true
                lifecycle_configuration:
                  idle_runtime_session_timeout: null
                  max_lifetime: null
              bedrock_agentcore:
                agent_id: baken_kaigi_cli-V4Bt684fL5
                agent_arn: arn:aws:bedrock-agentcore:ap-northeast-1:688567287706:runtime/baken_kaigi_cli-V4Bt684fL5
                agent_session_id: null
              codebuild:
                project_name: null
                execution_role: null
                source_bucket: null
              memory:
                mode: NO_MEMORY
                memory_id: null
                memory_arn: null
                memory_name: null
                event_expiry_days: 30
                first_invoke_memory_check_done: false
                was_created_by_toolkit: false
              identity:
                credential_providers: []
                workload: null
              aws_jwt:
                enabled: false
                audiences: []
                signing_algorithm: ES384
                issuer_url: null
                duration_seconds: 300
              authorizer_configuration: null
              request_header_configuration: null
              oauth_configuration: null
              api_key_env_var_name: null
              api_key_credential_provider_name: null
              is_generated_by_agentcore_create: false
          EOF
          # heredocの先頭スペースを削除
          sed -i 's/^          //' .bedrock_agentcore.yaml

      - name: Deploy AgentCore Runtime
        working-directory: backend/agentcore
        run: |
          echo "Deploying AgentCore Runtime..."
          agentcore launch --auto-update-on-conflict

      - name: Verify deployment
        working-directory: backend/agentcore
        run: |
          echo "Verifying AgentCore deployment..."
          agentcore status

      - name: Output AgentCore deployment summary
        run: |
          echo "## AgentCore Runtime Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Agent: baken_kaigi_cli" >> $GITHUB_STEP_SUMMARY
          echo "- Region: ap-northeast-1" >> $GITHUB_STEP_SUMMARY
          echo "- Deployment completed at $(date)" >> $GITHUB_STEP_SUMMARY
