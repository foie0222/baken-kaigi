<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åˆ¸ç¨®ãƒ»è²·ã„æ–¹ãƒ‡ãƒ¥ã‚¢ãƒ«ã‚·ãƒ¼ãƒˆ - é¦¬åˆ¸ä¼šè­° ãƒ¢ãƒƒã‚¯</title>
  <link rel="stylesheet" href="race-detail.css">
  <style>
    /* ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚¨ãƒªã‚¢ */
    .selector-area {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .selector-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      background: white;
      border: 1.5px solid #ddd;
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .selector-badge:active {
      transform: scale(0.98);
      background: #f5f5f5;
    }

    .selector-badge .label {
      color: #333;
    }

    .selector-badge .arrow {
      color: #888;
      font-size: 10px;
    }

    .selector-badge.bet-type {
      flex: 1;
    }

    .selector-badge.bet-method {
      flex: 1.2;
    }

    .selector-badge.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* ãƒœãƒˆãƒ ã‚·ãƒ¼ãƒˆå…±é€š */
    .bottom-sheet {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 300;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
    }

    .bottom-sheet.open {
      opacity: 1;
      pointer-events: auto;
    }

    .bottom-sheet-backdrop {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
    }

    .bottom-sheet-content {
      position: relative;
      background: white;
      width: 100%;
      max-width: 500px;
      border-radius: 16px 16px 0 0;
      padding: 20px;
      padding-bottom: calc(20px + env(safe-area-inset-bottom));
      transform: translateY(100%);
      transition: transform 0.3s ease;
      max-height: 70vh;
      overflow-y: auto;
    }

    .bottom-sheet.open .bottom-sheet-content {
      transform: translateY(0);
    }

    .bottom-sheet-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .bottom-sheet-title {
      font-size: 17px;
      font-weight: 700;
    }

    .bottom-sheet-close {
      width: 32px;
      height: 32px;
      border: none;
      background: #f5f5f5;
      border-radius: 50%;
      font-size: 14px;
      color: #666;
      cursor: pointer;
    }

    /* é¸æŠãƒªã‚¹ãƒˆ */
    .option-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .option-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      border: 2px solid #e8e8e8;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .option-item:active {
      transform: scale(0.99);
    }

    .option-item.selected {
      background: #e8f5e9;
      border-color: #1a5f2a;
    }

    .option-item.disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .option-check {
      width: 22px;
      height: 22px;
      border: 2px solid #ddd;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: transparent;
      flex-shrink: 0;
    }

    .option-item.selected .option-check {
      background: #1a5f2a;
      border-color: #1a5f2a;
      color: white;
    }

    .option-info {
      flex: 1;
    }

    .option-title {
      font-size: 15px;
      font-weight: 600;
      color: #333;
    }

    .option-desc {
      font-size: 11px;
      color: #888;
      margin-top: 2px;
    }

    .option-badge {
      font-size: 11px;
      font-weight: 600;
      color: #ff6b35;
      background: #fff3e0;
      padding: 3px 8px;
      border-radius: 4px;
    }

    /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³åŒºåˆ‡ã‚Š */
    .option-section {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #eee;
    }

    .option-section-title {
      font-size: 12px;
      font-weight: 600;
      color: #888;
      margin-bottom: 10px;
    }

    /* è»¸/ç›¸æ‰‹ãƒãƒƒã‚¸ */
    .axis-badge {
      position: absolute;
      top: 4px;
      left: 4px;
      background: #ff6b35;
      color: white;
      font-size: 9px;
      font-weight: 700;
      padding: 2px 4px;
      border-radius: 3px;
    }

    .axis-badge.partner {
      background: #1a5f2a;
    }

    /* é¸æŠãƒ’ãƒ³ãƒˆ */
    .selection-guide {
      background: linear-gradient(90deg, #e3f2fd 0%, #f3f8ff 100%);
      border-left: 3px solid #2196f3;
      padding: 10px 12px;
      margin-bottom: 12px;
      border-radius: 0 8px 8px 0;
      font-size: 12px;
      color: #1565c0;
    }

    .selection-guide.axis {
      background: linear-gradient(90deg, #fff3e0 0%, #fffaf5 100%);
      border-left-color: #ff6b35;
      color: #e65100;
    }

    .selection-guide.partner {
      background: linear-gradient(90deg, #e8f5e9 0%, #f5fff6 100%);
      border-left-color: #1a5f2a;
      color: #1a5f2a;
    }

    .bet-count-display {
      font-size: 11px;
      color: #1a5f2a;
      margin-left: auto;
      margin-right: 8px;
      cursor: pointer;
      padding: 4px 8px;
      background: #e8f5e9;
      border-radius: 4px;
      font-weight: 600;
      position: relative;
    }

    .bet-count-display:active {
      background: #c8e6c9;
    }

    /* ç‚¹æ•°å†…è¨³ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */
    .bet-breakdown-popup {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: white;
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 13px;
      z-index: 200;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
      max-width: 90%;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .bet-breakdown-popup.show {
      opacity: 1;
      pointer-events: auto;
    }

    .bet-breakdown-popup .breakdown-formula {
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .bet-breakdown-popup .breakdown-detail {
      font-size: 11px;
      color: #aaa;
    }

    /* é¸æŠã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ */
    .clear-selection-btn {
      display: none;
      align-items: center;
      gap: 4px;
      background: none;
      border: 1px solid #e53935;
      color: #e53935;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      margin-left: 8px;
    }

    .clear-selection-btn:active {
      background: #ffebee;
    }

    .clear-selection-btn.show {
      display: flex;
    }

    /* ã‚«ãƒ¼ãƒˆãƒœã‚¿ãƒ³ */
    .cart-btn {
      position: relative;
      background: rgba(255,255,255,0.2);
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      color: white;
      font-size: 14px;
    }

    .cart-btn:active {
      background: rgba(255,255,255,0.3);
    }

    .cart-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      background: #ff4444;
      color: white;
      font-size: 10px;
      font-weight: 700;
      min-width: 18px;
      height: 18px;
      border-radius: 9px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 4px;
    }

    /* è²·ã„ç›®å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆæ—¢å­˜ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰ */
    .bet-section {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-top: 16px;
      margin-bottom: 80px;
    }

    .bet-section h3 {
      font-size: 16px;
      margin: 0 0 16px 0;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .bet-input-group {
      margin-bottom: 16px;
    }

    .bet-input-group label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }

    .bet-input-group label span {
      font-weight: 400;
      color: #888;
    }

    .selected-horses-display {
      background: #f8f9fa;
      border: 2px solid #e8e8e8;
      border-radius: 8px;
      padding: 12px;
      min-height: 44px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .selected-horses-display.has-selection {
      border-color: #1a5f2a;
      background: #f0f9f1;
    }

    .selected-numbers {
      font-weight: 600;
      font-size: 15px;
      color: #1a5f2a;
      flex: 1;
    }

    .inline-bet-count {
      font-size: 12px;
      font-weight: 600;
      color: #1a5f2a;
      background: rgba(26, 95, 42, 0.1);
      padding: 4px 10px;
      border-radius: 12px;
      white-space: nowrap;
    }

    .no-selection {
      color: #999;
      font-size: 13px;
    }

    .selection-error {
      color: #c62828;
      font-size: 12px;
      margin-top: 6px;
    }

    .selection-label {
      font-size: 12px;
      color: #666;
      background: #f0f0f0;
      padding: 2px 8px;
      border-radius: 4px;
      margin-left: 4px;
    }

    .amount-input-wrapper {
      display: flex;
      align-items: center;
      background: #f8f9fa;
      border: 2px solid #e8e8e8;
      border-radius: 8px;
      overflow: hidden;
    }

    .amount-input-wrapper:focus-within {
      border-color: #1a5f2a;
    }

    .amount-stepper-btn {
      width: 44px;
      height: 44px;
      border: none;
      background: #e8e8e8;
      font-size: 20px;
      font-weight: 600;
      color: #333;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s;
      flex-shrink: 0;
    }

    .amount-stepper-btn:active {
      background: #d0d0d0;
    }

    .amount-stepper-btn:disabled {
      color: #bbb;
      cursor: not-allowed;
    }

    .amount-center {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 8px;
    }

    .currency-symbol {
      font-size: 16px;
      font-weight: 600;
      color: #666;
    }

    .amount-input {
      width: 80px;
      border: none;
      background: none;
      padding: 12px 4px;
      font-size: 18px;
      font-weight: 600;
      outline: none;
      text-align: center;
    }

    .amount-presets {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .preset-btn {
      flex: 1;
      padding: 8px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .preset-btn:active {
      background: #e8f5e9;
      border-color: #1a5f2a;
    }

    .bet-summary {
      display: flex;
      justify-content: space-between;
      padding: 12px;
      background: #e8f5e9;
      border-radius: 8px;
      margin-bottom: 12px;
      font-weight: 600;
      color: #1a5f2a;
    }

    .btn-primary {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #1a5f2a 0%, #2e7d32 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary:active {
      transform: scale(0.98);
    }

    .btn-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .btn-secondary {
      width: 100%;
      padding: 12px;
      background: white;
      color: #1a5f2a;
      border: 2px solid #1a5f2a;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 10px;
    }

    .btn-secondary:active {
      background: #e8f5e9;
    }

    /* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚¨ãƒªã‚¢ */
    .horse-checkboxes {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 4px;
      padding: 0 8px;
    }

    .checkbox-col {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }

    .checkbox-col input[type="checkbox"] {
      appearance: none;
      -webkit-appearance: none;
      width: 28px;
      height: 28px;
      border: 2px solid #ddd;
      border-radius: 6px;
      background: white;
      cursor: pointer;
      position: relative;
      transition: all 0.15s ease;
    }

    .checkbox-col input[type="checkbox"]:checked {
      background: #1a5f2a;
      border-color: #1a5f2a;
    }

    .checkbox-col input[type="checkbox"]:checked::after {
      content: 'âœ“';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 14px;
      font-weight: 700;
    }

    .checkbox-col input[type="checkbox"]:active {
      transform: scale(0.95);
    }

    /* åˆ—ã”ã¨ã®è‰²åˆ†ã‘ */
    .checkbox-col.col-1 input[type="checkbox"]:checked {
      background: #e53935;
      border-color: #e53935;
    }
    .checkbox-col.col-2 input[type="checkbox"]:checked {
      background: #1e88e5;
      border-color: #1e88e5;
    }
    .checkbox-col.col-3 input[type="checkbox"]:checked {
      background: #43a047;
      border-color: #43a047;
    }

    /* è»¸/ç›¸æ‰‹ */
    .checkbox-col.col-axis input[type="checkbox"]:checked {
      background: #ff6b35;
      border-color: #ff6b35;
    }
    .checkbox-col.col-partner input[type="checkbox"]:checked {
      background: #1a5f2a;
      border-color: #1a5f2a;
    }

    /* é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã¯å˜ä¸€ãƒã‚§ãƒƒã‚¯ */
    .checkbox-col.col-single input[type="checkbox"]:checked {
      background: #1a5f2a;
      border-color: #1a5f2a;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹åˆ— */
    .header-checkboxes {
      display: flex;
      justify-content: flex-end;
      gap: 4px;
      padding: 0 8px;
    }

    .header-checkbox-label {
      width: 28px;
      text-align: center;
      font-size: 10px;
      color: #666;
      font-weight: 600;
    }

    .header-checkbox-label.col-1 { color: #e53935; }
    .header-checkbox-label.col-2 { color: #1e88e5; }
    .header-checkbox-label.col-3 { color: #43a047; }
    .header-checkbox-label.col-axis { color: #ff6b35; }
    .header-checkbox-label.col-partner { color: #1a5f2a; }

    /* é¦¬ãƒªã‚¹ãƒˆã®ã‚°ãƒªãƒƒãƒ‰èª¿æ•´ï¼ˆå‹•çš„ã«å¤‰æ›´ï¼‰ */
    .horse-list-header {
      display: grid;
      padding: 10px 8px;
      background: #f8f9fa;
      font-size: 11px;
      color: #888;
      font-weight: 600;
    }

    .horse-item {
      display: grid;
      padding: 0;
      border-bottom: 1px solid #f0f0f0;
      align-items: center;
      min-height: 52px;
      position: relative;
    }

    /* 1åˆ—ãƒã‚§ãƒƒã‚¯ */
    .horse-list.cols-1 .horse-list-header,
    .horse-list.cols-1 .horse-item {
      grid-template-columns: 40px 1fr 48px 44px;
    }

    /* 2åˆ—ãƒã‚§ãƒƒã‚¯ */
    .horse-list.cols-2 .horse-list-header,
    .horse-list.cols-2 .horse-item {
      grid-template-columns: 40px 1fr 48px 68px;
    }

    /* 3åˆ—ãƒã‚§ãƒƒã‚¯ */
    .horse-list.cols-3 .horse-list-header,
    .horse-list.cols-3 .horse-item {
      grid-template-columns: 40px 1fr 48px 100px;
    }

    .horse-umaban {
      padding: 4px;
    }

    .umaban-number {
      width: 26px;
      height: 26px;
      font-size: 12px;
    }

    .horse-info {
      padding: 6px 4px;
    }

    .horse-name {
      font-size: 13px;
    }

    .horse-odds {
      font-size: 14px;
      padding-right: 0;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="app-header">
    <h1 class="app-title">é¦¬åˆ¸ä¼šè­°</h1>
    <button class="cart-btn" id="cart-btn" onclick="goToCart()">
      ğŸ›’
      <span class="cart-badge" id="cart-badge" style="display: none;">0</span>
    </button>
  </header>

  <!-- Main Content -->
  <main class="fade-in">
    <!-- Back Button -->
    <button class="back-btn" onclick="location.href='race-detail.html'">â† ãƒ™ãƒ¼ã‚¹ã«æˆ»ã‚‹</button>

    <!-- Race Detail Header -->
    <div class="race-detail-header">
      <div class="race-header-top">
        <span class="race-number">ä¸­å±± 1R</span>
        <a href="#" class="jra-link-btn">
          <span>å‡ºé¦¬è¡¨</span>
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
            <polyline points="15 3 21 3 21 9" />
            <line x1="10" y1="14" x2="21" y2="3" />
          </svg>
        </a>
      </div>
      <div class="race-name">3æ­³æœªå‹åˆ©</div>
      <div class="race-conditions">
        <span class="condition-tag">ãƒ€ãƒ¼ãƒˆ 1200m</span>
        <span class="condition-tag">é¦¬å ´: è‰¯</span>
        <span class="condition-tag">09:55 ç™ºèµ°</span>
      </div>
    </div>

    <!-- Selector Area -->
    <div class="selector-area">
      <div class="selector-badge bet-type" id="bet-type-badge">
        <span class="label" id="bet-type-label">å˜å‹</span>
        <span class="arrow">â–¼</span>
      </div>
      <div class="selector-badge bet-method" id="bet-method-badge">
        <span class="label" id="bet-method-label">é€šå¸¸</span>
        <span class="arrow">â–¼</span>
      </div>
      <button class="clear-selection-btn" id="clear-selection-btn">
        âœ• ã‚¯ãƒªã‚¢
      </button>
    </div>

    <!-- Selection Guide -->
    <div class="selection-guide" id="selection-guide" style="display: none;"></div>

    <!-- Horse List -->
    <div class="horse-list cols-1" id="horse-list">
      <div class="horse-list-header" id="horse-list-header">
        <span>é¦¬ç•ª</span>
        <span>é¦¬å</span>
        <span>å˜å‹</span>
        <div class="header-checkboxes" id="header-checkboxes"></div>
      </div>
      <div id="horse-list-body"></div>
    </div>

    <!-- è²·ã„ç›®å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="bet-section">
      <div class="bet-input-group">
        <label>é¸æŠã—ãŸé¦¬ç•ª <span id="selection-hint"></span></label>
        <div class="selected-horses-display" id="selected-horses-display">
          <span class="no-selection">ä¸Šã®ãƒªã‚¹ãƒˆã‹ã‚‰é¦¬ã‚’é¸æŠã—ã¦ãã ã•ã„</span>
        </div>
        <div class="selection-error" id="selection-error"></div>
      </div>

      <div class="bet-input-group">
        <label>é‡‘é¡</label>
        <div class="amount-input-wrapper">
          <button class="amount-stepper-btn" id="amount-minus">âˆ’</button>
          <div class="amount-center">
            <span class="currency-symbol">Â¥</span>
            <input type="number" class="amount-input" id="amount-input" value="100" min="100" step="100">
          </div>
          <button class="amount-stepper-btn" id="amount-plus">ï¼‹</button>
        </div>
        <div class="amount-presets">
          <button class="preset-btn" data-amount="100">Â¥100</button>
          <button class="preset-btn" data-amount="500">Â¥500</button>
          <button class="preset-btn" data-amount="1000">Â¥1,000</button>
          <button class="preset-btn" data-amount="5000">Â¥5,000</button>
        </div>
      </div>

      <div class="bet-summary" id="bet-summary" style="display: none;">
        <span id="bet-count-display"></span>
        <span id="bet-total-display"></span>
      </div>

      <button class="btn-primary" id="add-to-cart-btn" disabled>
        ğŸ›’ ã‚«ãƒ¼ãƒˆã«è¿½åŠ 
      </button>

      <button class="btn-secondary" id="view-cart-btn" style="display: none;">
        ã‚«ãƒ¼ãƒˆã‚’ç¢ºèªã™ã‚‹ï¼ˆ<span id="cart-count">0</span>ä»¶ï¼‰
      </button>
    </div>
  </main>

  <!-- åˆ¸ç¨®é¸æŠã‚·ãƒ¼ãƒˆ -->
  <div class="bottom-sheet" id="bet-type-sheet">
    <div class="bottom-sheet-backdrop"></div>
    <div class="bottom-sheet-content">
      <div class="bottom-sheet-header">
        <span class="bottom-sheet-title">åˆ¸ç¨®ã‚’é¸æŠ</span>
        <button class="bottom-sheet-close">âœ•</button>
      </div>
      <div class="option-list" id="bet-type-list"></div>
    </div>
  </div>

  <!-- è²·ã„æ–¹é¸æŠã‚·ãƒ¼ãƒˆ -->
  <div class="bottom-sheet" id="bet-method-sheet">
    <div class="bottom-sheet-backdrop"></div>
    <div class="bottom-sheet-content">
      <div class="bottom-sheet-header">
        <span class="bottom-sheet-title">è²·ã„æ–¹ã‚’é¸æŠ</span>
        <button class="bottom-sheet-close">âœ•</button>
      </div>
      <div class="option-list" id="bet-method-list"></div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <button class="nav-item active">
      <span class="nav-icon">ğŸ‡</span>
      <span class="nav-label">ãƒ¬ãƒ¼ã‚¹</span>
    </button>
    <button class="nav-item">
      <span class="nav-icon">ğŸ“Š</span>
      <span class="nav-label">æç›Š</span>
    </button>
    <button class="nav-item">
      <span class="nav-icon">ğŸ“œ</span>
      <span class="nav-label">å±¥æ­´</span>
    </button>
    <button class="nav-item">
      <span class="nav-icon">âš™ï¸</span>
      <span class="nav-label">è¨­å®š</span>
    </button>
  </nav>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- ç‚¹æ•°å†…è¨³ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
  <div class="bet-breakdown-popup" id="bet-breakdown-popup">
    <div class="breakdown-formula" id="breakdown-formula"></div>
    <div class="breakdown-detail" id="breakdown-detail"></div>
  </div>

  <script>
    // æ ç•ªã‚«ãƒ©ãƒ¼
    const wakuColors = {
      1: '#ffffff', 2: '#000000', 3: '#ff0000', 4: '#0066cc',
      5: '#ffcc00', 6: '#00aa00', 7: '#ff6600', 8: '#ff66cc'
    };
    const wakuTextColors = {
      1: '#000000', 2: '#ffffff', 3: '#ffffff', 4: '#ffffff',
      5: '#000000', 6: '#ffffff', 7: '#ffffff', 8: '#ffffff'
    };

    // Mock Data
    const horses = [
      { number: 1, waku: 1, name: 'ã‚·ã‚»ã‚¤ãƒ’ãƒŠã‚¿', jockey: 'å‰ç”°è±Š', weight: '56.0', odds: '3.4' },
      { number: 2, waku: 1, name: 'ã‚¢ãƒ‰ãƒŸ', jockey: 'è…åŸæ˜è‰¯', weight: '56.0', odds: '12.5' },
      { number: 3, waku: 2, name: 'ãƒ“ã‚¢ãƒ¼ãƒ¬', jockey: 'å†…ç”°åšå¹¸', weight: '56.0', odds: '8.2' },
      { number: 4, waku: 2, name: 'ã‚¸ãƒ§ã‚¤ã‚¢ãƒŸãƒ¼ã‚¢', jockey: 'ä¸‰æµ¦çš‡æˆ', weight: '56.0', odds: '5.6' },
      { number: 5, waku: 3, name: 'ã‚¹ã‚«ãƒƒãƒˆ', jockey: 'ä¸Šé‡Œç›´æ±°', weight: '54.0', odds: '25.3' },
      { number: 6, waku: 3, name: 'ã‚¢ã‚¤ã‚¢ãƒ³ãƒ–ãƒ©ãƒ³ãƒ‰', jockey: 'ä¸¸ç”°æ­ä»‹', weight: '56.0', odds: '18.7' },
      { number: 7, waku: 4, name: 'ã‚¤ãƒŒãƒœã‚¦ãƒã‚­ãƒ©ãƒ¡ã‚­', jockey: 'ã‚­ãƒ³ã‚°', weight: '54.0', odds: '45.2' },
      { number: 8, waku: 4, name: 'ãƒ¯ãƒ³ãƒ€ãƒ¼ãƒãƒªã‚¨ãƒ³ã‚¹', jockey: 'æŸ´ç”°å¤§çŸ¥', weight: '56.0', odds: '32.1' },
      { number: 9, waku: 5, name: 'ã‚°ãƒ©ãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³', jockey: 'æ¨ªå±±æ­¦å²', weight: '56.0', odds: '6.8' },
      { number: 10, waku: 5, name: 'ã‚µã‚¯ãƒ©ãƒ–ãƒ¬ã‚¤ãƒ–', jockey: 'ç”°è¾ºè£•ä¿¡', weight: '56.0', odds: '15.4' },
      { number: 11, waku: 6, name: 'ãƒˆãƒ¼ã‚»ãƒ³ãƒ•ã‚¡ãƒ³ãƒˆãƒ ', jockey: 'æˆ¸å´åœ­å¤ª', weight: '56.0', odds: '4.2' },
      { number: 12, waku: 6, name: 'ãƒ€ãƒãƒ³ã‚¹ãƒãƒƒã‚·ãƒ¥', jockey: 'ãƒ«ãƒ¡ãƒ¼ãƒ«', weight: '56.0', odds: '2.1' },
    ];

    // åˆ¸ç¨®å®šç¾©
    const betTypes = [
      { type: 'win', label: 'å˜å‹', desc: '1ç€ã‚’å½“ã¦ã‚‹', required: 1, ordered: false },
      { type: 'place', label: 'è¤‡å‹', desc: '3ç€ä»¥å†…ã‚’å½“ã¦ã‚‹', required: 1, ordered: false },
      { type: 'quinella', label: 'é¦¬é€£', desc: '1-2ç€ã‚’å½“ã¦ã‚‹ï¼ˆé †ä¸åŒï¼‰', required: 2, ordered: false },
      { type: 'quinella_place', label: 'ãƒ¯ã‚¤ãƒ‰', desc: '3ç€ä»¥å†…ã®2é ­ã‚’å½“ã¦ã‚‹', required: 2, ordered: false },
      { type: 'exacta', label: 'é¦¬å˜', desc: '1-2ç€ã‚’é †ç•ªé€šã‚Šã«å½“ã¦ã‚‹', required: 2, ordered: true },
      { type: 'trio', label: 'ä¸‰é€£è¤‡', desc: '1-2-3ç€ã‚’å½“ã¦ã‚‹ï¼ˆé †ä¸åŒï¼‰', required: 3, ordered: false },
      { type: 'trifecta', label: 'ä¸‰é€£å˜', desc: '1-2-3ç€ã‚’é †ç•ªé€šã‚Šã«å½“ã¦ã‚‹', required: 3, ordered: true },
    ];

    // è²·ã„æ–¹å®šç¾©ï¼ˆåˆ¸ç¨®ã«ã‚ˆã£ã¦å‹•çš„ã«å¤‰ã‚ã‚‹ï¼‰
    function getBetMethods(betType) {
      const config = betTypes.find(b => b.type === betType);
      if (!config) return [];

      const methods = [
        { id: 'normal', label: 'é€šå¸¸', desc: `${config.required}é ­ã‚’ã´ã£ãŸã‚Šé¸æŠ` },
      ];

      // 2é ­ä»¥ä¸Šã®åˆ¸ç¨®ã®ã¿
      if (config.required >= 2) {
        methods.push({ id: 'box', label: 'ãƒœãƒƒã‚¯ã‚¹', desc: 'é¸ã‚“ã é¦¬ã®å…¨çµ„ã¿åˆã‚ã›' });

        if (config.ordered) {
          // é¦¬å˜
          if (config.required === 2) {
            methods.push({ id: 'nagashi_1', label: '1ç€æµã—', desc: 'è»¸ãŒ1ç€ã€ç›¸æ‰‹ãŒ2ç€' });
            methods.push({ id: 'nagashi_2', label: '2ç€æµã—', desc: 'ç›¸æ‰‹ãŒ1ç€ã€è»¸ãŒ2ç€' });
            methods.push({ id: 'nagashi_multi', label: 'ãƒãƒ«ãƒ', desc: '1ç€æµã—ï¼‹2ç€æµã—', badge: 'Ã—2' });
          }
          // ä¸‰é€£å˜
          if (config.required === 3) {
            methods.push({ id: 'nagashi_1', label: 'è»¸1é ­ 1ç€æµã—', desc: 'è»¸ãŒ1ç€å›ºå®š' });
            methods.push({ id: 'nagashi_2', label: 'è»¸1é ­ 2ç€æµã—', desc: 'è»¸ãŒ2ç€å›ºå®š' });
            methods.push({ id: 'nagashi_3', label: 'è»¸1é ­ 3ç€æµã—', desc: 'è»¸ãŒ3ç€å›ºå®š' });
            methods.push({ id: 'nagashi_1_multi', label: 'è»¸1é ­ ãƒãƒ«ãƒ', desc: 'è»¸ãŒã©ã“ã§ã‚‚OK', badge: 'Ã—3' });
            methods.push({ id: 'nagashi_12', label: 'è»¸2é ­ 1-2ç€æµã—', desc: 'è»¸2é ­ãŒ1-2ç€' });
            methods.push({ id: 'nagashi_13', label: 'è»¸2é ­ 1-3ç€æµã—', desc: 'è»¸2é ­ãŒ1-3ç€' });
            methods.push({ id: 'nagashi_23', label: 'è»¸2é ­ 2-3ç€æµã—', desc: 'è»¸2é ­ãŒ2-3ç€' });
            methods.push({ id: 'nagashi_2_multi', label: 'è»¸2é ­ ãƒãƒ«ãƒ', desc: 'è»¸2é ­ãŒã©ã“ã§ã‚‚OK', badge: 'Ã—6' });
          }
        } else {
          // é¦¬é€£ãƒ»ãƒ¯ã‚¤ãƒ‰ãƒ»ä¸‰é€£è¤‡
          methods.push({ id: 'nagashi', label: 'è»¸1é ­æµã—', desc: 'è»¸ã‹ã‚‰ç›¸æ‰‹ã¸' });
          if (config.required === 3) {
            methods.push({ id: 'nagashi_2', label: 'è»¸2é ­æµã—', desc: 'è»¸2é ­ã‹ã‚‰ç›¸æ‰‹ã¸' });
          }
        }

        methods.push({ id: 'formation', label: 'ãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³', desc: 'ç€é †ã”ã¨ã«å€™è£œã‚’æŒ‡å®š' });
      }

      return methods;
    }

    // State
    let currentBetType = 'win';
    let currentMethod = 'normal';
    // åˆ—ã”ã¨ã®é¸æŠï¼ˆãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œï¼‰
    let selections = {
      col1: [],  // 1ç€/è»¸/1é ­ç›®
      col2: [],  // 2ç€/ç›¸æ‰‹/2é ­ç›®
      col3: [],  // 3ç€/3é ­ç›®
    };
    let betAmount = 100;

    // ã‚«ãƒ¼ãƒˆï¼ˆLocalStorageæ°¸ç¶šåŒ–ï¼‰
    let cart = JSON.parse(localStorage.getItem('baken-kaigi-mock-cart') || '[]');
    let cartIdCounter = cart.length > 0 ? Math.max(...cart.map(c => c.id)) + 1 : 1;

    // DOM Elements
    const betTypeBadge = document.getElementById('bet-type-badge');
    const betTypeLabel = document.getElementById('bet-type-label');
    const betMethodBadge = document.getElementById('bet-method-badge');
    const betMethodLabel = document.getElementById('bet-method-label');
    const betTypeSheet = document.getElementById('bet-type-sheet');
    const betMethodSheet = document.getElementById('bet-method-sheet');
    const betTypeList = document.getElementById('bet-type-list');
    const betMethodList = document.getElementById('bet-method-list');
    const horseListBody = document.getElementById('horse-list-body');
    const selectionGuide = document.getElementById('selection-guide');
    const clearSelectionBtn = document.getElementById('clear-selection-btn');
    const toast = document.getElementById('toast');
    const betBreakdownPopup = document.getElementById('bet-breakdown-popup');
    const breakdownFormula = document.getElementById('breakdown-formula');
    const breakdownDetail = document.getElementById('breakdown-detail');

    // è²·ã„ç›®ã‚»ã‚¯ã‚·ãƒ§ãƒ³é–¢é€£DOM
    const selectedHorsesDisplay = document.getElementById('selected-horses-display');
    const selectionHint = document.getElementById('selection-hint');
    const selectionError = document.getElementById('selection-error');
    const amountInput = document.getElementById('amount-input');
    const betSummary = document.getElementById('bet-summary');
    const betCountDisplay = document.getElementById('bet-count-display');
    const betTotalDisplay = document.getElementById('bet-total-display');
    const addToCartBtn = document.getElementById('add-to-cart-btn');
    const viewCartBtn = document.getElementById('view-cart-btn');
    const cartCount = document.getElementById('cart-count');
    const cartBadge = document.getElementById('cart-badge');

    function init() {
      setupSheets();
      setupAmountControl();
      setupClearButton();
      setupBreakdownPopup();
      setupPresetButtons();
      renderHorseList();
      updateUI();
      updateCartBadge();
    }

    function getCurrentBetTypeConfig() {
      return betTypes.find(b => b.type === currentBetType);
    }

    function getCurrentMethodConfig() {
      const methods = getBetMethods(currentBetType);
      return methods.find(m => m.id === currentMethod);
    }

    // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹åˆ—ã®è¨­å®šã‚’å–å¾—
    function getColumnConfig() {
      const config = getCurrentBetTypeConfig();
      const isNagashi = currentMethod.startsWith('nagashi');
      const isFormation = currentMethod === 'formation';
      const isBox = currentMethod === 'box';

      if (currentMethod === 'normal' || isBox) {
        // é€šå¸¸ãƒ»ãƒœãƒƒã‚¯ã‚¹: 1åˆ—
        return {
          count: 1,
          columns: [{ id: 'col1', label: 'é¸æŠ', class: 'col-single' }]
        };
      }

      if (isNagashi) {
        // æµã—: è»¸ã¨ç›¸æ‰‹ã®2åˆ—ï¼ˆç€é †ã«å¿œã˜ã¦é…ç½®ã‚’å¤‰ãˆã‚‹ï¼‰
        // é¦¬å˜ã®å ´åˆ
        if (config.required === 2 && config.ordered) {
          if (currentMethod === 'nagashi_2') {
            // 2ç€æµã—: ç›¸æ‰‹(1ç€) | è»¸(2ç€) ã®é †
            return {
              count: 2,
              columns: [
                { id: 'col2', label: '1ç€', class: 'col-partner' },
                { id: 'col1', label: '2ç€è»¸', class: 'col-axis' }
              ]
            };
          } else {
            // 1ç€æµã—/ãƒãƒ«ãƒ: è»¸(1ç€) | ç›¸æ‰‹(2ç€) ã®é †
            return {
              count: 2,
              columns: [
                { id: 'col1', label: '1ç€è»¸', class: 'col-axis' },
                { id: 'col2', label: '2ç€', class: 'col-partner' }
              ]
            };
          }
        }
        // ä¸‰é€£å˜ã®å ´åˆ
        if (config.required === 3 && config.ordered) {
          if (currentMethod === 'nagashi_1') {
            return {
              count: 2,
              columns: [
                { id: 'col1', label: '1ç€è»¸', class: 'col-axis' },
                { id: 'col2', label: '2-3ç€', class: 'col-partner' }
              ]
            };
          } else if (currentMethod === 'nagashi_2') {
            return {
              count: 2,
              columns: [
                { id: 'col2', label: '1,3ç€', class: 'col-partner' },
                { id: 'col1', label: '2ç€è»¸', class: 'col-axis' }
              ]
            };
          } else if (currentMethod === 'nagashi_3') {
            return {
              count: 2,
              columns: [
                { id: 'col2', label: '1-2ç€', class: 'col-partner' },
                { id: 'col1', label: '3ç€è»¸', class: 'col-axis' }
              ]
            };
          } else {
            // ãƒãƒ«ãƒ/è»¸2é ­æµã—
            return {
              count: 2,
              columns: [
                { id: 'col1', label: 'è»¸', class: 'col-axis' },
                { id: 'col2', label: 'ç›¸æ‰‹', class: 'col-partner' }
              ]
            };
          }
        }
        // é¦¬é€£ãƒ»ãƒ¯ã‚¤ãƒ‰ãƒ»ä¸‰é€£è¤‡ï¼ˆé †ä¸åŒï¼‰
        return {
          count: 2,
          columns: [
            { id: 'col1', label: 'è»¸', class: 'col-axis' },
            { id: 'col2', label: 'ç›¸æ‰‹', class: 'col-partner' }
          ]
        };
      }

      if (isFormation) {
        // ãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³: ç€é †åˆ†ã®åˆ—
        if (config.required === 2) {
          if (config.ordered) {
            return {
              count: 2,
              columns: [
                { id: 'col1', label: '1ç€', class: 'col-1' },
                { id: 'col2', label: '2ç€', class: 'col-2' }
              ]
            };
          } else {
            return {
              count: 2,
              columns: [
                { id: 'col1', label: '1é ­ç›®', class: 'col-1' },
                { id: 'col2', label: '2é ­ç›®', class: 'col-2' }
              ]
            };
          }
        } else if (config.required === 3) {
          if (config.ordered) {
            return {
              count: 3,
              columns: [
                { id: 'col1', label: '1ç€', class: 'col-1' },
                { id: 'col2', label: '2ç€', class: 'col-2' },
                { id: 'col3', label: '3ç€', class: 'col-3' }
              ]
            };
          } else {
            return {
              count: 3,
              columns: [
                { id: 'col1', label: '1é ­ç›®', class: 'col-1' },
                { id: 'col2', label: '2é ­ç›®', class: 'col-2' },
                { id: 'col3', label: '3é ­ç›®', class: 'col-3' }
              ]
            };
          }
        }
      }

      return { count: 1, columns: [{ id: 'col1', label: '', class: 'col-single' }] };
    }

    // ã‚·ãƒ¼ãƒˆã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    function setupSheets() {
      // åˆ¸ç¨®ãƒãƒƒã‚¸
      betTypeBadge.addEventListener('click', () => {
        renderBetTypeList();
        betTypeSheet.classList.add('open');
      });

      // è²·ã„æ–¹ãƒãƒƒã‚¸
      betMethodBadge.addEventListener('click', () => {
        const config = getCurrentBetTypeConfig();
        if (config.required === 1) return;  // å˜å‹ãƒ»è¤‡å‹ã¯é¸æŠä¸å¯
        renderBetMethodList();
        betMethodSheet.classList.add('open');
      });

      // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ãƒ»èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯
      document.querySelectorAll('.bottom-sheet').forEach(sheet => {
        sheet.querySelector('.bottom-sheet-backdrop').addEventListener('click', () => {
          sheet.classList.remove('open');
        });
        sheet.querySelector('.bottom-sheet-close').addEventListener('click', () => {
          sheet.classList.remove('open');
        });
      });
    }

    // åˆ¸ç¨®ãƒªã‚¹ãƒˆã‚’æç”»
    function renderBetTypeList() {
      betTypeList.innerHTML = betTypes.map(bt => `
        <div class="option-item ${currentBetType === bt.type ? 'selected' : ''}" data-type="${bt.type}">
          <div class="option-check">âœ“</div>
          <div class="option-info">
            <div class="option-title">${bt.label}</div>
            <div class="option-desc">${bt.desc}</div>
          </div>
        </div>
      `).join('');

      betTypeList.querySelectorAll('.option-item').forEach(item => {
        item.addEventListener('click', () => {
          const newType = item.dataset.type;
          if (newType !== currentBetType) {
            currentBetType = newType;
            currentMethod = 'normal';
            resetSelections();
          }
          betTypeSheet.classList.remove('open');
          renderHorseList();
          updateUI();
        });
      });
    }

    // è²·ã„æ–¹ãƒªã‚¹ãƒˆã‚’æç”»
    function renderBetMethodList() {
      const methods = getBetMethods(currentBetType);
      const config = getCurrentBetTypeConfig();

      // ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘
      const normalMethods = methods.filter(m => m.id === 'normal' || m.id === 'box');
      const nagashiMethods = methods.filter(m => m.id.startsWith('nagashi'));
      const formationMethods = methods.filter(m => m.id === 'formation');

      let html = '';

      // åŸºæœ¬
      html += normalMethods.map(m => renderMethodOption(m)).join('');

      // æµã—
      if (nagashiMethods.length > 0) {
        html += `<div class="option-section"><div class="option-section-title">æµã—</div>`;
        html += nagashiMethods.map(m => renderMethodOption(m)).join('');
        html += `</div>`;
      }

      // ãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
      if (formationMethods.length > 0) {
        html += `<div class="option-section"><div class="option-section-title">ãã®ä»–</div>`;
        html += formationMethods.map(m => renderMethodOption(m)).join('');
        html += `</div>`;
      }

      betMethodList.innerHTML = html;
    }

    // è²·ã„æ–¹ãƒªã‚¹ãƒˆã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒªã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
    betMethodList.addEventListener('click', (e) => {
      const item = e.target.closest('.option-item');
      if (!item || item.classList.contains('disabled')) return;

      const newMethod = item.dataset.method;
      if (newMethod !== currentMethod) {
        currentMethod = newMethod;
        resetSelections();
      }
      betMethodSheet.classList.remove('open');
      renderHorseList();
      updateUI();
    });

    function renderMethodOption(method) {
      const isSelected = currentMethod === method.id;
      return `
        <div class="option-item ${isSelected ? 'selected' : ''}" data-method="${method.id}">
          <div class="option-check">âœ“</div>
          <div class="option-info">
            <div class="option-title">${method.label}</div>
            <div class="option-desc">${method.desc}</div>
          </div>
          ${method.badge ? `<span class="option-badge">${method.badge}</span>` : ''}
        </div>
      `;
    }

    // é¦¬ãƒªã‚¹ãƒˆæç”»
    function renderHorseList() {
      const colConfig = getColumnConfig();
      const horseList = document.getElementById('horse-list');
      const headerCheckboxes = document.getElementById('header-checkboxes');

      // åˆ—æ•°ã«å¿œã˜ãŸã‚¯ãƒ©ã‚¹è¨­å®š
      horseList.className = `horse-list cols-${colConfig.count}`;

      // ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãƒ©ãƒ™ãƒ«
      headerCheckboxes.innerHTML = colConfig.columns.map(col =>
        `<span class="header-checkbox-label ${col.class}">${col.label}</span>`
      ).join('');

      // é¦¬ãƒªã‚¹ãƒˆ
      horseListBody.innerHTML = horses.map(horse => {
        const wakuColor = wakuColors[horse.waku];
        const wakuTextColor = wakuTextColors[horse.waku];
        const borderStyle = horse.waku === 1 ? 'border: 1px solid #ccc;' : '';

        // å„åˆ—ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ç”Ÿæˆ
        const checkboxesHtml = colConfig.columns.map(col => {
          const isChecked = selections[col.id]?.includes(horse.number);
          return `
            <div class="checkbox-col ${col.class}">
              <input type="checkbox"
                ${isChecked ? 'checked' : ''}
                data-number="${horse.number}"
                data-col="${col.id}">
            </div>
          `;
        }).join('');

        // è¡ŒãŒé¸æŠã•ã‚Œã¦ã„ã‚‹ã‹ï¼ˆã„ãšã‚Œã‹ã®åˆ—ã«å«ã¾ã‚Œã¦ã„ã‚Œã°ï¼‰
        const isSelected = colConfig.columns.some(col => selections[col.id]?.includes(horse.number));

        return `
          <div class="horse-item ${isSelected ? 'selected' : ''}" data-number="${horse.number}">
            <div class="horse-umaban">
              <div class="umaban-number" style="background: ${wakuColor}; color: ${wakuTextColor}; ${borderStyle}">${horse.number}</div>
            </div>
            <div class="horse-info">
              <div class="horse-name">${horse.name}</div>
              <div class="horse-detail">
                <span>${horse.jockey}</span>
                <span>${horse.weight}kg</span>
              </div>
            </div>
            <div class="horse-odds">${horse.odds}</div>
            <div class="horse-checkboxes">
              ${checkboxesHtml}
            </div>
          </div>
        `;
      }).join('');

      // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã‚¤ãƒ™ãƒ³ãƒˆ
      horseListBody.querySelectorAll('.checkbox-col input').forEach(checkbox => {
        checkbox.addEventListener('change', (e) => {
          e.stopPropagation();
          const number = parseInt(checkbox.dataset.number);
          const colId = checkbox.dataset.col;
          toggleHorseInColumn(number, colId);
        });
      });
    }

    function getAxisCount() {
      if (['nagashi_12', 'nagashi_13', 'nagashi_23', 'nagashi_2_multi'].includes(currentMethod)) {
        return 2;
      }
      if (currentMethod === 'nagashi_2' && getCurrentBetTypeConfig()?.required === 3) {
        return 2;
      }
      return 1;
    }

    // åˆ—å†…ã®é¸æŠã‚’ãƒˆã‚°ãƒ«
    function toggleHorseInColumn(number, colId) {
      const config = getCurrentBetTypeConfig();
      const colConfig = getColumnConfig();
      const isNagashi = currentMethod.startsWith('nagashi');

      if (currentMethod === 'normal') {
        // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰: å¿…è¦é ­æ•°ã¾ã§
        if (selections.col1.includes(number)) {
          selections.col1 = selections.col1.filter(n => n !== number);
        } else if (selections.col1.length < config.required) {
          selections.col1.push(number);
        }
      } else if (currentMethod === 'box') {
        // ãƒœãƒƒã‚¯ã‚¹: ç„¡åˆ¶é™
        if (selections.col1.includes(number)) {
          selections.col1 = selections.col1.filter(n => n !== number);
        } else {
          selections.col1.push(number);
        }
      } else if (isNagashi) {
        // æµã—: è»¸ã¨ç›¸æ‰‹
        const axisCount = getAxisCount();
        if (colId === 'col1') {
          // è»¸
          if (selections.col1.includes(number)) {
            selections.col1 = selections.col1.filter(n => n !== number);
          } else if (selections.col1.length < axisCount) {
            // ç›¸æ‰‹ã‹ã‚‰å‰Šé™¤ã—ã¦è»¸ã«è¿½åŠ 
            selections.col2 = selections.col2.filter(n => n !== number);
            selections.col1.push(number);
          }
        } else {
          // ç›¸æ‰‹
          if (selections.col2.includes(number)) {
            selections.col2 = selections.col2.filter(n => n !== number);
          } else if (!selections.col1.includes(number)) {
            // è»¸ã«ã„ãªã‘ã‚Œã°ç›¸æ‰‹ã«è¿½åŠ 
            selections.col2.push(number);
          }
        }
      } else if (currentMethod === 'formation') {
        // ãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³: å„åˆ—ç‹¬ç«‹
        if (selections[colId].includes(number)) {
          selections[colId] = selections[colId].filter(n => n !== number);
        } else {
          selections[colId].push(number);
        }
      }

      renderHorseList();
      updateUI();
    }

    // é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
    function resetSelections() {
      selections = { col1: [], col2: [], col3: [] };
    }

    function calculateBetCount() {
      const config = getCurrentBetTypeConfig();
      const isNagashi = currentMethod.startsWith('nagashi');
      const axisCount = getAxisCount();

      if (currentMethod === 'normal') {
        return selections.col1.length === config.required ? 1 : 0;
      }

      if (currentMethod === 'box') {
        const n = selections.col1.length;
        const minRequired = config.required + 1;
        if (n < minRequired) return 0;
        if (config.required === 2) {
          return config.ordered ? n * (n - 1) : combination(n, 2);
        } else if (config.required === 3) {
          return config.ordered ? n * (n - 1) * (n - 2) : combination(n, 3);
        }
      }

      if (isNagashi) {
        const axisHorses = selections.col1;
        const partnerHorses = selections.col2;
        if (axisHorses.length !== axisCount || partnerHorses.length === 0) return 0;

        const partners = partnerHorses.length;
        let baseCount = 0;

        if (config.required === 2) {
          baseCount = partners;
          if (currentMethod === 'nagashi_multi') return baseCount * 2;
        } else if (config.required === 3) {
          if (axisCount === 1) {
            baseCount = partners * (partners - 1);
            if (currentMethod === 'nagashi_1_multi') return baseCount * 3;
          } else {
            baseCount = partners;
            if (currentMethod === 'nagashi_2_multi') return baseCount * 6;
          }
        }
        return baseCount;
      }

      if (currentMethod === 'formation') {
        // ãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç‚¹æ•°è¨ˆç®—
        const col1 = selections.col1.length;
        const col2 = selections.col2.length;
        const col3 = selections.col3.length;

        if (config.required === 2) {
          if (col1 === 0 || col2 === 0) return 0;
          // é‡è¤‡ã‚’è€ƒæ…®ã—ãŸè¨ˆç®—
          if (config.ordered) {
            // é¦¬å˜ãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            let count = 0;
            selections.col1.forEach(h1 => {
              selections.col2.forEach(h2 => {
                if (h1 !== h2) count++;
              });
            });
            return count;
          } else {
            // é¦¬é€£ãƒ»ãƒ¯ã‚¤ãƒ‰ãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            const all = [...new Set([...selections.col1, ...selections.col2])];
            return combination(all.length, 2);
          }
        } else if (config.required === 3) {
          if (col1 === 0 || col2 === 0 || col3 === 0) return 0;
          if (config.ordered) {
            // ä¸‰é€£å˜ãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            let count = 0;
            selections.col1.forEach(h1 => {
              selections.col2.forEach(h2 => {
                if (h1 === h2) return;
                selections.col3.forEach(h3 => {
                  if (h1 !== h3 && h2 !== h3) count++;
                });
              });
            });
            return count;
          } else {
            // ä¸‰é€£è¤‡ãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            const all = [...new Set([...selections.col1, ...selections.col2, ...selections.col3])];
            return combination(all.length, 3);
          }
        }
      }

      return 0;
    }

    function combination(n, r) {
      if (r > n) return 0;
      let result = 1;
      for (let i = 0; i < r; i++) {
        result = result * (n - i) / (i + 1);
      }
      return Math.round(result);
    }

    function updateUI() {
      const config = getCurrentBetTypeConfig();
      const methodConfig = getCurrentMethodConfig();
      const betCount = calculateBetCount();
      const isNagashi = currentMethod.startsWith('nagashi');
      const isFormation = currentMethod === 'formation';
      const colConfig = getColumnConfig();

      // ãƒãƒƒã‚¸æ›´æ–°
      betTypeLabel.textContent = config.label;
      betMethodLabel.textContent = methodConfig?.label || 'é€šå¸¸';

      // å˜å‹ãƒ»è¤‡å‹ã¯è²·ã„æ–¹é¸æŠä¸å¯
      if (config.required === 1) {
        betMethodBadge.classList.add('disabled');
      } else {
        betMethodBadge.classList.remove('disabled');
      }

      // é¸æŠã‚¬ã‚¤ãƒ‰
      updateSelectionGuide();

      // é¸æŠãƒ’ãƒ³ãƒˆï¼ˆåˆ¸ç¨®Ã—è²·ã„æ–¹ï¼‰
      const methodLabel = methodConfig?.label || 'é€šå¸¸';
      if (methodLabel === 'é€šå¸¸') {
        selectionHint.innerHTML = `<span class="selection-label">${config.label}</span>`;
      } else {
        selectionHint.innerHTML = `<span class="selection-label">${config.label} Ã— ${methodLabel}</span>`;
      }

      // é¸æŠã—ãŸé¦¬ç•ªè¡¨ç¤º
      const hasAnySelection = selections.col1.length > 0 || selections.col2.length > 0 || selections.col3.length > 0;
      if (hasAnySelection) {
        let displayText;
        if (isNagashi) {
          const axisText = selections.col1.length > 0 ? `è»¸:${selections.col1.join(',')}` : '';
          const partnerText = selections.col2.length > 0 ? `â†’${selections.col2.join(',')}` : '';
          displayText = axisText + partnerText;
        } else if (isFormation) {
          const parts = colConfig.columns.map(col => {
            const nums = selections[col.id] || [];
            return nums.length > 0 ? nums.join(',') : '-';
          });
          displayText = parts.join(' Ã— ');
        } else {
          const sorted = [...selections.col1].sort((a, b) => a - b);
          displayText = config.ordered ? selections.col1.join(' â†’ ') : sorted.join(' - ');
        }

        // ç‚¹æ•°è¡¨ç¤ºï¼ˆbetCount > 0 ã®å ´åˆã®ã¿ï¼‰
        const betCountHtml = betCount > 0
          ? `<span class="inline-bet-count">${betCount}ç‚¹</span>`
          : '';

        selectedHorsesDisplay.innerHTML = `
          <span class="selected-numbers">${displayText}</span>
          ${betCountHtml}
          <button class="clear-selection-btn show" onclick="clearAndUpdate()">ã‚¯ãƒªã‚¢</button>
        `;
        selectedHorsesDisplay.classList.add('has-selection');
      } else {
        selectedHorsesDisplay.innerHTML = '<span class="no-selection">ä¸Šã®ãƒªã‚¹ãƒˆã‹ã‚‰é¦¬ã‚’é¸æŠã—ã¦ãã ã•ã„</span>';
        selectedHorsesDisplay.classList.remove('has-selection');
      }

      // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³è¡¨ç¤ºï¼ˆã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚¨ãƒªã‚¢ï¼‰
      if (hasAnySelection) {
        clearSelectionBtn.classList.add('show');
      } else {
        clearSelectionBtn.classList.remove('show');
      }

      // ç‚¹æ•°ãƒ»é‡‘é¡ã‚µãƒãƒªãƒ¼
      if (betCount > 0) {
        const total = betAmount * betCount;
        betCountDisplay.textContent = `${betCount}ç‚¹`;
        betTotalDisplay.textContent = `Â¥${total.toLocaleString()}`;
        betSummary.style.display = 'flex';
      } else {
        betSummary.style.display = 'none';
      }

      // ãƒœã‚¿ãƒ³çŠ¶æ…‹
      addToCartBtn.disabled = betCount === 0;

      // ã‚«ãƒ¼ãƒˆç¢ºèªãƒœã‚¿ãƒ³
      if (cart.length > 0) {
        viewCartBtn.style.display = 'block';
        cartCount.textContent = cart.length;
      } else {
        viewCartBtn.style.display = 'none';
      }
    }

    function clearAndUpdate() {
      resetSelections();
      renderHorseList();
      updateUI();
    }

    function updateSelectionGuide() {
      const config = getCurrentBetTypeConfig();
      const isNagashi = currentMethod.startsWith('nagashi');
      const isFormation = currentMethod === 'formation';
      const axisCount = getAxisCount();
      const colConfig = getColumnConfig();

      if (isNagashi) {
        if (selections.col1.length < axisCount) {
          const remaining = axisCount - selections.col1.length;
          selectionGuide.textContent = `ğŸ¯ è»¸é¦¬ã‚’ã‚ã¨${remaining}é ­é¸æŠ`;
          selectionGuide.className = 'selection-guide axis';
          selectionGuide.style.display = 'block';
        } else if (selections.col2.length === 0) {
          selectionGuide.textContent = 'ğŸ‘¥ ç›¸æ‰‹é¦¬ã‚’é¸æŠ';
          selectionGuide.className = 'selection-guide partner';
          selectionGuide.style.display = 'block';
        } else {
          selectionGuide.style.display = 'none';
        }
      } else if (isFormation) {
        // ãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³: å„åˆ—ã®çŠ¶æ…‹ã‚’ç¢ºèª
        const emptyColumns = colConfig.columns.filter(col => (selections[col.id]?.length || 0) === 0);
        if (emptyColumns.length > 0) {
          const labels = emptyColumns.map(col => col.label).join('ãƒ»');
          selectionGuide.textContent = `ğŸ“‹ ${labels}ã‚’é¸æŠ`;
          selectionGuide.className = 'selection-guide';
          selectionGuide.style.display = 'block';
        } else {
          selectionGuide.style.display = 'none';
        }
      } else if (currentMethod === 'normal') {
        const remaining = config.required - selections.col1.length;
        if (remaining > 0) {
          selectionGuide.textContent = `ğŸ“Œ ã‚ã¨${remaining}é ­é¸æŠ`;
          selectionGuide.className = 'selection-guide';
          selectionGuide.style.display = 'block';
        } else {
          selectionGuide.style.display = 'none';
        }
      } else if (currentMethod === 'box') {
        const minRequired = config.required + 1;
        if (selections.col1.length < minRequired) {
          selectionGuide.textContent = `ğŸ“¦ ${minRequired}é ­ä»¥ä¸Šé¸æŠ`;
          selectionGuide.className = 'selection-guide';
          selectionGuide.style.display = 'block';
        } else {
          selectionGuide.style.display = 'none';
        }
      } else {
        selectionGuide.style.display = 'none';
      }
    }

    function setupAmountControl() {
      const minusBtn = document.getElementById('amount-minus');
      const plusBtn = document.getElementById('amount-plus');

      amountInput.value = betAmount;

      amountInput.addEventListener('change', () => {
        betAmount = parseInt(amountInput.value) || 100;
        if (betAmount < 100) betAmount = 100;
        amountInput.value = betAmount;
        updateUI();
      });

      minusBtn.addEventListener('click', () => {
        if (betAmount > 100) {
          betAmount = betAmount <= 500 ? betAmount - 100 : betAmount - 500;
          if (betAmount < 100) betAmount = 100;
          amountInput.value = betAmount;
          updateUI();
        }
      });

      plusBtn.addEventListener('click', () => {
        betAmount = betAmount < 500 ? betAmount + 100 : betAmount + 500;
        amountInput.value = betAmount;
        updateUI();
      });
    }

    function setupPresetButtons() {
      document.querySelectorAll('.preset-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          betAmount = parseInt(btn.dataset.amount);
          amountInput.value = betAmount;
          updateUI();
        });
      });
    }

    function setupClearButton() {
      clearSelectionBtn.addEventListener('click', () => {
        resetSelections();
        renderHorseList();
        updateUI();
      });
    }

    function setupBreakdownPopup() {
      let hideTimeout;

      betCountDisplay.addEventListener('click', () => {
        const breakdown = getBetBreakdown();
        if (!breakdown) return;

        breakdownFormula.textContent = breakdown.formula;
        breakdownDetail.textContent = breakdown.detail;
        betBreakdownPopup.classList.add('show');

        clearTimeout(hideTimeout);
        hideTimeout = setTimeout(() => {
          betBreakdownPopup.classList.remove('show');
        }, 3000);
      });

      // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å¤–ã‚¿ãƒƒãƒ—ã§é–‰ã˜ã‚‹
      document.addEventListener('click', (e) => {
        if (!betCountDisplay.contains(e.target) && !betBreakdownPopup.contains(e.target)) {
          betBreakdownPopup.classList.remove('show');
        }
      });
    }

    function getBetBreakdown() {
      const config = getCurrentBetTypeConfig();
      const isNagashi = currentMethod.startsWith('nagashi');
      const isFormation = currentMethod === 'formation';
      const betCount = calculateBetCount();

      if (betCount === 0) return null;

      if (currentMethod === 'normal') {
        return {
          formula: '1ç‚¹',
          detail: `${selections.col1.join('â†’')} ã®1é€šã‚Š`
        };
      }

      if (currentMethod === 'box') {
        const n = selections.col1.length;
        if (config.required === 2) {
          if (config.ordered) {
            return {
              formula: `${n} Ã— ${n-1} = ${betCount}ç‚¹`,
              detail: `${n}é ­ã‹ã‚‰2é ­ã‚’é †ç•ªã«é¸ã¶çµ„ã¿åˆã‚ã›`
            };
          } else {
            return {
              formula: `${n}C2 = ${betCount}ç‚¹`,
              detail: `${n}é ­ã‹ã‚‰2é ­ã‚’é¸ã¶çµ„ã¿åˆã‚ã›`
            };
          }
        } else if (config.required === 3) {
          if (config.ordered) {
            return {
              formula: `${n} Ã— ${n-1} Ã— ${n-2} = ${betCount}ç‚¹`,
              detail: `${n}é ­ã‹ã‚‰3é ­ã‚’é †ç•ªã«é¸ã¶çµ„ã¿åˆã‚ã›`
            };
          } else {
            return {
              formula: `${n}C3 = ${betCount}ç‚¹`,
              detail: `${n}é ­ã‹ã‚‰3é ­ã‚’é¸ã¶çµ„ã¿åˆã‚ã›`
            };
          }
        }
      }

      if (isNagashi) {
        const axisCount = getAxisCount();
        const partners = selections.col2.length;
        const multiplier = currentMethod.includes('multi') ? (config.required === 2 ? 2 : (axisCount === 1 ? 3 : 6)) : 1;
        const baseCount = betCount / multiplier;

        if (config.required === 2) {
          if (multiplier > 1) {
            return {
              formula: `${partners} Ã— ${multiplier} = ${betCount}ç‚¹`,
              detail: `ç›¸æ‰‹${partners}é ­ Ã— ãƒãƒ«ãƒ${multiplier}å€`
            };
          }
          return {
            formula: `${partners}ç‚¹`,
            detail: `è»¸1é ­ â†’ ç›¸æ‰‹${partners}é ­`
          };
        } else if (config.required === 3) {
          if (axisCount === 1) {
            if (multiplier > 1) {
              return {
                formula: `${partners} Ã— ${partners-1} Ã— ${multiplier} = ${betCount}ç‚¹`,
                detail: `ç›¸æ‰‹${partners}é ­ã®é †åˆ— Ã— ãƒãƒ«ãƒ${multiplier}å€`
              };
            }
            return {
              formula: `${partners} Ã— ${partners-1} = ${betCount}ç‚¹`,
              detail: `è»¸1é ­å›ºå®šã€ç›¸æ‰‹${partners}é ­ã®é †åˆ—`
            };
          } else {
            if (multiplier > 1) {
              return {
                formula: `${partners} Ã— ${multiplier} = ${betCount}ç‚¹`,
                detail: `ç›¸æ‰‹${partners}é ­ Ã— ãƒãƒ«ãƒ${multiplier}å€`
              };
            }
            return {
              formula: `${partners}ç‚¹`,
              detail: `è»¸2é ­å›ºå®š â†’ ç›¸æ‰‹${partners}é ­`
            };
          }
        }
      }

      if (isFormation) {
        const col1 = selections.col1.length;
        const col2 = selections.col2.length;
        const col3 = selections.col3.length;

        if (config.required === 2) {
          return {
            formula: `${col1} Ã— ${col2} â†’ ${betCount}ç‚¹`,
            detail: `é‡è¤‡é™¤å¤–å¾Œã®å®Ÿçµ„ã¿åˆã‚ã›æ•°`
          };
        } else if (config.required === 3) {
          return {
            formula: `${col1} Ã— ${col2} Ã— ${col3} â†’ ${betCount}ç‚¹`,
            detail: `é‡è¤‡é™¤å¤–å¾Œã®å®Ÿçµ„ã¿åˆã‚ã›æ•°`
          };
        }
      }

      return { formula: `${betCount}ç‚¹`, detail: '' };
    }

    function showToast(message) {
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2000);
    }

    // ã‚«ãƒ¼ãƒˆã«è¿½åŠ 
    addToCartBtn.addEventListener('click', () => {
      const betCount = calculateBetCount();
      if (betCount === 0) return;

      const config = getCurrentBetTypeConfig();
      const methodConfig = getCurrentMethodConfig();
      const total = betAmount * betCount;

      // ã‚«ãƒ¼ãƒˆã«è¿½åŠ 
      const colConfig = getColumnConfig();
      let horseNumbersDisplay;
      if (currentMethod === 'formation') {
        horseNumbersDisplay = colConfig.columns.map(col => {
          const nums = selections[col.id] || [];
          return nums.join(',');
        }).join(' Ã— ');
      } else if (currentMethod.startsWith('nagashi')) {
        horseNumbersDisplay = `è»¸${selections.col1.join(',')}â†’${selections.col2.join(',')}`;
      } else {
        horseNumbersDisplay = [...selections.col1].sort((a, b) => a - b).join('-');
      }

      cart.push({
        id: cartIdCounter++,
        raceVenue: 'ä¸­å±±',
        raceNumber: '1R',
        raceName: '3æ­³æœªå‹åˆ©',
        betType: currentBetType,
        betTypeLabel: config.label,
        method: currentMethod,
        methodLabel: methodConfig?.label || 'é€šå¸¸',
        horseNumbers: horseNumbersDisplay,
        betCount: betCount,
        amount: total,
      });

      // LocalStorageã«ä¿å­˜
      saveCart();

      showToast(`${config.label} ${methodConfig?.label || ''} ${betCount}ç‚¹ Â¥${total.toLocaleString()} ã‚’è¿½åŠ `);

      resetSelections();
      renderHorseList();
      updateUI();
      updateCartBadge();
    });

    // ã‚«ãƒ¼ãƒˆã‚’ç¢ºèªãƒœã‚¿ãƒ³
    viewCartBtn.addEventListener('click', () => {
      goToCart();
    });

    // ã‚«ãƒ¼ãƒˆé–¢é€£é–¢æ•°
    function saveCart() {
      localStorage.setItem('baken-kaigi-mock-cart', JSON.stringify(cart));
    }

    function updateCartBadge() {
      const itemCount = cart.length;
      if (itemCount > 0) {
        cartBadge.textContent = itemCount;
        cartBadge.style.display = 'flex';
        viewCartBtn.style.display = 'block';
        cartCount.textContent = itemCount;
      } else {
        cartBadge.style.display = 'none';
        viewCartBtn.style.display = 'none';
      }
    }

    function goToCart() {
      // å®Ÿéš›ã®ã‚¢ãƒ—ãƒªã§ã¯CartPageã«é·ç§»
      // ãƒ¢ãƒƒã‚¯ã§ã¯ã‚¢ãƒ©ãƒ¼ãƒˆã§ä»£ç”¨
      if (cart.length === 0) {
        showToast('ã‚«ãƒ¼ãƒˆã«é¦¬åˆ¸ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }

      const totalCount = cart.reduce((sum, item) => sum + item.betCount, 0);
      const totalAmount = cart.reduce((sum, item) => sum + item.amount, 0);

      const summary = cart.map(item =>
        `ãƒ»${item.raceVenue}${item.raceNumber} ${item.betTypeLabel} ${item.horseNumbers} (${item.betCount}ç‚¹ Â¥${item.amount.toLocaleString()})`
      ).join('\n');

      const action = confirm(
        `ğŸ›’ ã‚«ãƒ¼ãƒˆç¢ºèª\n\n${summary}\n\nåˆè¨ˆ: ${totalCount}ç‚¹ Â¥${totalAmount.toLocaleString()}\n\n` +
        `OKã‚’æŠ¼ã™ã¨ã‚«ãƒ¼ãƒˆã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™\nï¼ˆå®Ÿéš›ã®ã‚¢ãƒ—ãƒªã§ã¯ã‚«ãƒ¼ãƒˆãƒšãƒ¼ã‚¸ã«é·ç§»ã—ã¾ã™ï¼‰`
      );

      if (action) {
        cart = [];
        saveCart();
        updateCartBadge();
        updateUI();
        showToast('ã‚«ãƒ¼ãƒˆã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
      }
    }

    init();
  </script>
</body>
</html>
