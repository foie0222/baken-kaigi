# 買い目提案ロジック

`generate_bet_proposal` ツールが買い目を生成するまでの全体フロー。

## 全体フロー

```mermaid
flowchart TD
    START([ユーザー: 買い目提案して]) --> P0

    subgraph P0 [Phase 0: データ収集]
        P0A[レース情報取得] --> P0B[AI予想取得]
        P0B --> P0C[脚質データ取得]
        P0C --> P0D[スピード指数取得]
        P0D --> P0E[近走成績取得]
    end

    P0 --> P1[Phase 1: ペルソナ設定]
    P1 --> P2

    subgraph P2 [Phase 2: ペース予想 + 軸馬選定]
        P2A[逃げ馬の数からペース予想] --> P2B[全馬の複合スコア算出]
        P2B --> P2C[上位2頭を軸馬に選定]
    end

    P2 --> P3

    subgraph P3 [Phase 3: 難易度判定 + 券種選定]
        P3A[頭数・条件・会場から難易度★算出] --> P3B[★に応じて券種を自動選定]
    end

    P3 --> P4

    subgraph P4 [Phase 4: 買い目生成]
        P4A[相手馬を上位4頭選出] --> P4B[軸×相手の組み合わせ生成]
        P4B --> P4C[期待値計算]
        P4C --> P4D{トリガミ?}
        P4D -->|合成オッズ < 2.0| P4E[除外]
        P4D -->|OK| P4F[期待値順にソート]
        P4F --> P4G[上位N点を採用 + 信頼度付与]
    end

    P4 --> P5

    subgraph P5 [Phase 5: 見送りゲート]
        P5A{見送りスコア ≥ 7?}
        P5A -->|Yes| P5B[予算を50%に削減]
        P5A -->|No| P5C[予算そのまま]
    end

    P5 --> P6[Phase 6: 予算配分]
    P6 --> P7[Phase 7: 提案理由 + コメント生成]
    P7 --> RESULT([提案結果を返却])
```

## Phase 0: データ収集

5つのデータソースからレース情報を取得する。

| データ | 取得元 | 主な項目 |
|--------|--------|----------|
| レース情報 | JRA-VAN API | 出走馬、オッズ、人気、会場、条件 |
| AI予想 | DynamoDB | 馬番、順位、スコア（複数ソース） |
| 脚質データ | JRA-VAN API | 逃げ/先行/差し/追込/自在 |
| スピード指数 | DynamoDB | 各馬のスピード指数 |
| 近走成績 | DynamoDB | 直近5走の着順 |

## Phase 1: ペルソナ設定

`character_type` に応じて各種パラメータを調整する。

```mermaid
flowchart LR
    CT{character_type} -->|analyst| A[バランス型]
    CT -->|conservative| B[堅実型]
    CT -->|intuition| C[直感型]
    CT -->|aggressive| D[攻撃型]
```

| パラメータ | analyst | conservative | intuition | aggressive |
|-----------|---------|-------------|-----------|------------|
| AI重視度 | 0.5 | **0.6** | 0.3 | 0.3 |
| オッズ乖離重視度 | 0.3 | 0.2 | **0.5** | **0.5** |
| 高信頼への配分 | 50% | **60%** | 40% | 35% |
| 低信頼への配分 | 20% | **10%** | 30% | **40%** |
| トリガミ閾値 | 2.0 | **2.5** | 1.5 | 1.5 |
| 見送り閾値 | 7 | **6** | 8 | **9** |
| 最大点数 | 8 | **5** | 8 | 8 |
| 券種傾向 | バランス | ワイド寄り | 馬単/三連複 | 三連単 |

## Phase 2: ペース予想 + 軸馬選定

### ペース予想

```
逃げ馬 3頭以上 → ハイペース（差し・追込有利）
逃げ馬 2頭    → ミドルペース（先行・差し有利）
逃げ馬 0〜1頭 → スローペース（逃げ・先行有利）
```

### 軸馬の複合スコア

各馬に以下の重み付きスコアを算出し、上位2頭を軸馬に選定する。

```mermaid
flowchart LR
    subgraph 複合スコア
        AI[AI指数スコア<br>weight: 0.5] --> SUM((加重平均))
        OG[オッズ乖離スコア<br>weight: 0.3] --> SUM
        PC[ペース相性スコア<br>weight: 0.2] --> SUM
        SI[スピード指数<br>weight: 0.2] --> SUM
        FM[近走フォーム<br>weight: 0.15] --> SUM
    end
    SUM --> RANK[全馬をスコア順にソート]
    RANK --> TOP[上位2頭 = 軸馬]
```

**AI指数スコア**: AI順位1位=100pt、以降5ptずつ減少（18位=15pt）

**オッズ乖離スコア**: AI上位なのにオッズが高い馬にボーナス（市場の見落とし候補）

**ペース相性**: 予想ペースと脚質の相性マトリクス

| | 逃げ | 先行 | 差し | 追込 | 自在 |
|---|---|---|---|---|---|
| **ハイ** | -1.0 | -0.5 | **+1.0** | **+1.0** | +0.5 |
| **ミドル** | 0 | +0.5 | +0.5 | 0 | +0.5 |
| **スロー** | **+1.0** | **+1.0** | -0.5 | -1.0 | +0.5 |

**スピード指数**: レース内での順位を100〜15ptにマッピング

**近走フォーム**: 直近5走の着順を重み付き（5,4,3,2,1）で集計

## Phase 3: 難易度判定 + 券種選定

### 難易度スコア算出

```
upset_score = 0

# 頭数
16頭以上: +1  /  13〜15頭: +1  /  8頭以下: -1

# レース条件
ハンデ戦: +2  /  障害戦: +2  /  新馬戦: +1  /  G1: -1  /  G2: -1

# 会場
福島/中京/小倉: +1  /  京都/阪神: -1

# ★変換
difficulty_stars = clamp(upset_score + 2, 1, 5)
```

> LLMはこの★をベースラインの参考値として使い、AI予想の分散・ペース・
> 馬場・距離なども総合的に考慮してコメントする。

### 券種の自動選定

```mermaid
flowchart LR
    S1[★1-2 堅い] --> BT1[馬連・馬単]
    S3[★3 標準] --> BT3[馬連・三連複]
    S4[★4 荒れ模様] --> BT4[三連複・ワイド]
    S5[★5 大荒れ] --> BT5[ワイド]
```

## Phase 4: 買い目生成

### 相手馬の選出

軸馬以外の全馬を複合スコア順にソートし、上位4頭を相手馬に選出。

### 組み合わせ生成

```
馬連/馬単/ワイドの場合:
  軸 × 相手 = 最大 2軸 × 4相手 = 8通り

三連複/三連単の場合:
  軸 × 相手2頭 = 最大 2軸 × C(4,2) = 12通り
```

### オッズ推定 → 期待値 → フィルタ

単勝オッズから各券種のオッズを推定する。

```
推定オッズ = 幾何平均(各馬の単勝オッズ) × 券種倍率
```

| 券種 | 倍率 |
|------|------|
| ワイド | 0.45 |
| 馬連 | 0.85 |
| 三連複 | 1.5 |
| 馬単 | 1.7 |
| 三連単 | 4.0 |

```
期待値 = 推定オッズ × JRA統計の推定的中率

合成オッズ < 2.0 → トリガミとして除外
```

残った買い目を期待値順にソートし、上位N点を採用。

### 信頼度の付与

採用した買い目を期待値順に3グループに分ける。

```
上位 1/3 → high
中位 1/3 → medium
下位 1/3 → low
```

## Phase 5: 見送りゲート

複数の要因から見送りスコア（0〜10）を算出する。

```mermaid
flowchart TD
    D[難易度<br>★5: +4 / ★4: +3 / ★3: +1] --> SS((見送り<br>スコア))
    AI[AI上位5頭のスコア差<br>≤15pt: +3 / ≤30pt: +1] --> SS
    OD[オッズ団子状態: +1] --> SS
    MH[16頭以上: +1] --> SS
    HP[ハイペース予想: +1] --> SS

    SS --> J{スコア ≥ 7?}
    J -->|Yes| SKIP[見送り推奨<br>予算50%削減]
    J -->|No| J2{スコア ≥ 5?}
    J2 -->|Yes| CAUTION[慎重に検討]
    J2 -->|No| OK[通常判断]
```

## Phase 6: 予算配分

信頼度グループごとに予算を配分し、期待値に応じて各買い目に分配する。

```mermaid
flowchart TD
    B[予算 10,000円] --> H[high枠: 50%<br>5,000円]
    B --> M[medium枠: 30%<br>3,000円]
    B --> L[low枠: 20%<br>2,000円]

    H --> H1[買い目A: EV高<br>→ 3,000円]
    H --> H2[買い目B: EV中<br>→ 2,000円]
    M --> M1[買い目C<br>→ 1,500円]
    M --> M2[買い目D<br>→ 1,500円]
    L --> L1[買い目E<br>→ 1,100円]
    L --> L2[買い目F<br>→ 900円]
```

- 各グループ内では期待値に比例して配分
- 最低100円/点を保証
- 100円単位に丸め
- 余りは最も期待値の高い買い目に加算

## 定数一覧

| 定数 | 値 | 用途 |
|------|-----|------|
| MAX_AXIS_HORSES | 2 | 軸馬の最大数 |
| MAX_PARTNERS | 4 | 相手馬の最大数 |
| MAX_BETS | 8 | 買い目の最大数（デフォルト） |
| MIN_BET_AMOUNT | 100 | 最低掛け金（円） |
| TORIGAMI_THRESHOLD | 2.0 | 合成オッズがこれ未満で除外 |
| SKIP_GATE_THRESHOLD | 7 | 見送り推奨の閾値 |
| SKIP_BUDGET_REDUCTION | 0.5 | 見送り時の予算削減率 |

## 関連ファイル

| ファイル | 役割 |
|---------|------|
| `backend/agentcore/tools/bet_proposal.py` | 買い目提案の主ロジック |
| `backend/agentcore/tools/pace_analysis.py` | ペース予想・難易度判定 |
| `backend/agentcore/tools/risk_analysis.py` | 見送り判定 |
| `backend/agentcore/tools/bet_analysis.py` | 期待値・トリガミ計算 |
| `backend/agentcore/tools/race_data.py` | レースデータ取得 |
| `backend/agentcore/prompts/bet_proposal.py` | エージェント用プロンプト |
