# Unit 4: JRA IPAT購入統合

## 概要

| 項目 | 内容 |
|------|------|
| ユニット名 | JRA IPAT購入統合 |
| ストーリー数 | 6件 |
| 認証 | 必要 |
| 並行開発 | Unit 5完了後 |
| 依存関係 | Unit 5（ユーザー管理・認証）、Unit 3（負け額限度額チェック） |

---

## ユーザーストーリー一覧

| ID | タイトル | 優先度 |
|----|---------|--------|
| US-03-001 | IPAT認証情報の登録 | Should have |
| US-03-002 | IPAT認証情報の変更・削除 | Could have |
| US-03-003 | IPAT残高の表示 | Should have |
| US-03-004 | 馬券の購入 | Must have |
| US-03-006 | 購入結果の自動取得 | Should have |
| US-03-007 | 購入履歴の確認 | Could have |

**備考**: US-03-005（購入時の負け額限度額チェック）はUnit 3（中毒防止機能）に移動

---

## US-03-001: IPAT認証情報の登録

**ストーリー**
> ログインユーザーとして、JRA IPATの認証情報（加入者番号、暗証番号、P-ARS番号）を登録したい。なぜなら、アプリから直接馬券を購入できるようにしたいから。

| 項目 | 内容 |
|------|------|
| 優先度 | Should have |
| 認証 | **必要** |
| 対象ペルソナ | 全ペルソナ |

**受け入れ条件**
- [ ] IPAT連携設定画面で加入者番号、暗証番号、P-ARS番号を入力できる
- [ ] 入力フィールドはパスワード形式（マスク表示）
- [ ] 登録ボタンタップ時にIPATとの接続確認が行われる
- [ ] 接続成功時は「連携完了」のメッセージが表示される
- [ ] 接続失敗時はエラー理由が表示される
- [ ] 認証情報はAES-256で暗号化して保存される

---

## US-03-002: IPAT認証情報の変更・削除

**ストーリー**
> ログインユーザーとして、登録したIPAT認証情報を変更または削除したい。なぜなら、暗証番号の変更時やIPAT連携を解除したい場合があるから。

| 項目 | 内容 |
|------|------|
| 優先度 | Could have |
| 認証 | **必要** |
| 対象ペルソナ | 全ペルソナ |

**受け入れ条件**
- [ ] IPAT連携設定画面で認証情報を変更できる
- [ ] 変更・削除時はアカウントパスワードの再入力が必要
- [ ] 認証情報削除時は確認ダイアログが表示される
- [ ] 削除後は購入機能が利用不可になることが明示される
- [ ] 削除完了後はIPAT連携設定画面に戻る

---

## US-03-003: IPAT残高の表示

**ストーリー**
> ログインユーザーとして、IPAT口座の残高を確認したい。なぜなら、賭けられる金額を把握してから購入を検討したいから。

| 項目 | 内容 |
|------|------|
| 優先度 | Should have |
| 認証 | **必要** |
| 対象ペルソナ | 全ペルソナ |

**受け入れ条件**
- [ ] IPAT連携済みの場合、購入画面に残高が表示される
- [ ] ダッシュボードにIPAT残高が表示される
- [ ] 更新ボタンで最新の残高を取得できる
- [ ] 残高取得中はローディング表示される
- [ ] 残高取得エラー時はエラーメッセージが表示される
- [ ] IPAT未連携の場合は「IPAT連携が必要です」と表示される

---

## US-03-004: 馬券の購入

**ストーリー**
> ログインユーザーとして、AIとの対話後にそのまま馬券を購入したい。なぜなら、別のアプリに切り替える手間なくシームレスに賭けたいから。

| 項目 | 内容 |
|------|------|
| 優先度 | **Must have** |
| 認証 | **必要** |
| 対象ペルソナ | 全ペルソナ |

**受け入れ条件**
- [ ] AI相談画面から「購入する」ボタンで購入確認画面に遷移できる
- [ ] 購入確認画面で買い目、金額、合計金額が表示される
- [ ] IPAT残高が表示され、残高不足の場合は警告表示される
- [ ] 「購入確定」ボタンでIPAT経由の購入が実行される
- [ ] 購入処理中はローディング表示される
- [ ] 購入完了後は「購入完了」画面が表示される
- [ ] 購入エラー時はエラー理由が表示される

---

## US-03-006: 購入結果の自動取得

**ストーリー**
> ログインユーザーとして、馬券の購入結果（当たり/外れ、払戻金）を自動で取得してほしい。なぜなら、手動入力の手間なく正確な損益を把握したいから。

| 項目 | 内容 |
|------|------|
| 優先度 | Should have |
| 認証 | **必要** |
| 対象ペルソナ | 全ペルソナ |

**受け入れ条件**
- [ ] レース確定後、購入結果が自動的に取得される
- [ ] 結果取得後、プッシュ通知で結果が通知される
- [ ] 当選時は「おめでとうございます！」と払戻金額が表示される
- [ ] 外れ時は「残念でした」と購入金額が損失として記録される
- [ ] 結果は損益ダッシュボードに自動反映される
- [ ] 結果は賭け履歴に自動反映される

---

## US-03-007: 購入履歴の確認

**ストーリー**
> ログインユーザーとして、IPAT経由で購入した馬券の履歴を確認したい。なぜなら、購入内容と結果を振り返りたいから。

| 項目 | 内容 |
|------|------|
| 優先度 | Could have |
| 認証 | **必要** |
| 対象ペルソナ | 全ペルソナ |

**受け入れ条件**
- [ ] 購入履歴が賭け履歴（US-02-007）と統合して表示される
- [ ] IPAT経由の購入には「IPAT」バッジが表示される
- [ ] 各購入にレース名、日付、買い目、金額、結果、払戻金が表示される
- [ ] 購入をタップすると詳細（購入時刻、AI相談内容へのリンク等）が表示される
- [ ] フィルタで「IPAT購入のみ」を絞り込める
