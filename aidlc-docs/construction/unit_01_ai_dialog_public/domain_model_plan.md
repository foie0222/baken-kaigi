# Unit 1: AI対話機能（認証不要） - ドメインモデリング計画

## 概要

本計画は、Unit 1（AI対話機能・認証不要）の9件のユーザーストーリーを実装するためのドメインモデルを設計するステップを定義します。

---

## 確認事項

### [Question] 1: 外部レースデータの扱いについて

ユーザーストーリーUS-01-001、US-01-002では、レース情報（レース一覧、出走馬、オッズなど）を表示する必要があります。このデータは外部ソース（JRA等）から取得すると想定されます。

**A) 外部データはドメインモデル外として扱う**
- レースデータはリードモデル（読み取り専用）として扱い、ドメインモデルには含めない
- ドメインモデルは「買い目」「カート」「AIフィードバック」に集中

**B) 外部データもドメインモデルに含める**
- レース、出走馬などをドメインエンティティとして定義
- 外部データをドメインオブジェクトに変換して利用

[Answer] A

---

### [Question] 2: AI会話機能のドメインモデル境界について

US-01-004（AIへの賭け相談）では、AIとの自由な会話（追加質問）が可能とあります。

**A) AI会話はインフラストラクチャ層として扱う**
- AIとの通信はドメイン外のインフラとして扱う
- ドメインモデルは会話の「入力」と「結果」のみを扱う

**B) AI会話をドメインモデルに含める**
- 会話セッション、メッセージなどをドメインオブジェクトとして定義
- 会話履歴の管理もドメインロジックに含める

[Answer] 折衷案を採用
- 会話の「構造」（セッション、メッセージ、フィードバック）はドメイン層
- AI APIとの「通信」はインフラ層
- AIコーチングはこのシステムのコア価値なので、会話構造はドメインで表現する

---

### [Question] 3: カート内の買い目に対するユーザー識別について

Unit 1は認証不要ですが、カート機能があります。

**A) セッションベースのカート（匿名カート）**
- ブラウザセッションで一時的に保持
- ドメインモデルではユーザー識別を持たない

**B) 将来のログイン統合を考慮したカート**
- カートにオプショナルなユーザーID参照を持つ
- Unit 5（認証）との統合を見据えた設計

[Answer] B

---

## 作業ステップ

### Phase 1: ドメイン分析
- [x] **ステップ 1: ユーザーストーリーからドメイン概念を抽出** ✓ 2026-01-19
  - 各ストーリーに登場するドメイン用語を洗い出し
  - ユビキタス言語（用語集）の作成
  - 出力: `docs/ubiquitous_language.md`

### Phase 2: エンティティと値オブジェクトの設計
- [x] **ステップ 2: エンティティの特定と設計** ✓ 2026-01-19
  - ライフサイクルと識別子を持つオブジェクトを特定
  - 各エンティティの属性と振る舞いを定義
  - 出力: `docs/entities.md`

- [x] **ステップ 3: 値オブジェクトの特定と設計** ✓ 2026-01-19
  - 不変で識別子を持たないオブジェクトを特定
  - 各値オブジェクトの属性と振る舞いを定義
  - 出力: `docs/value_objects.md`

### Phase 3: 集約とサービスの設計
- [x] **ステップ 4: 集約の設計** ✓ 2026-01-19
  - トランザクション境界となる集約を特定
  - 集約ルートと集約内の関連を定義
  - 出力: `docs/aggregates.md`

- [x] **ステップ 5: ドメインサービスの設計** ✓ 2026-01-19
  - エンティティに属さないドメインロジックを特定
  - 各サービスの責務と操作を定義
  - 出力: `docs/domain_services.md`

### Phase 4: 相互作用の設計
- [x] **ステップ 6: ユースケースごとのドメインモデル相互作用の設計** ✓ 2026-01-19
  - 各ユーザーストーリーにおけるドメインオブジェクト間の相互作用を定義
  - 出力: `docs/interactions.md`

### Phase 5: 最終確認
- [x] **ステップ 7: ドメインモデル概要図の作成** ✓ 2026-01-19
  - 全体像を示すMermaid図を作成
  - 出力: `docs/domain_model_overview.md`

- [x] **ステップ 8: 全ユーザーストーリーのカバレッジ確認** ✓ 2026-01-19
  - 9件のストーリーが全てドメインモデルでカバーされていることを確認

---

## カバレッジ確認結果

| ストーリー | タイトル | 主要ドメインオブジェクト | カバレッジ |
|-----------|---------|----------------------|----------|
| US-01-001 | レース一覧の表示 | 外部リードモデル | ✓ |
| US-01-002 | レース詳細情報の表示 | 外部リードモデル | ✓ |
| US-01-003 | 買い目の入力 | BetSelection, BetSelectionValidator | ✓ |
| US-01-003a | 買い目のカート追加 | Cart, CartItem | ✓ |
| US-01-003b | カートの管理 | Cart, CartItem | ✓ |
| US-01-003c | 複数買い目のまとめてAI相談 | Cart, ConsultationSession, ConsultationService | ✓ |
| US-01-004 | AIへの賭け相談 | ConsultationSession, Message | ✓ |
| US-01-005 | データに基づくフィードバック | DataFeedback, FeedbackGenerator | ✓ |
| US-01-006 | 掛け金に対するフィードバック | AmountFeedback, FeedbackGenerator | ✓ |
| **合計** | **9件** | | **全件カバー ✓** |

---

## 出力ファイル一覧

| ファイル | 内容 | 状態 |
|---------|------|------|
| `docs/ubiquitous_language.md` | ユビキタス言語（用語集） | ✓ |
| `docs/entities.md` | エンティティの定義 | ✓ |
| `docs/value_objects.md` | 値オブジェクトの定義 | ✓ |
| `docs/aggregates.md` | 集約の定義 | ✓ |
| `docs/domain_services.md` | ドメインサービスの定義 | ✓ |
| `docs/interactions.md` | ユースケースごとの相互作用 | ✓ |
| `docs/domain_model_overview.md` | ドメインモデル概要図（Mermaid） | ✓ |

---

## 備考

- アーキテクチャコンポーネント（リポジトリ、コントローラ等）は対象外
- コードは生成しない
- ドメインモデルのみを設計する
